# v1.1 Pre-Pilot Hardening -- Integration Check

**Milestone:** v1.1 Pre-Pilot Hardening
**Phases Checked:** 6 (PDF Court-Readiness), 7 (Notifications & Sharing), 8 (Search, Filtering & Templates), 9 (Export, Bulk & Admin)
**Date:** 2026-02-07
**Checker:** Integration verification agent

---

## Integration Check Complete

### Wiring Summary

| Metric | Count | Status |
|--------|-------|--------|
| **Connected exports** | 12 | Properly wired |
| **Orphaned exports** | 1 | Created but unused by other phases |
| **Missing connections** | 3 | Expected connections not found |

### API Coverage

| Metric | Count | Status |
|--------|-------|--------|
| **Consumed API routes** | 10 | Have UI or service callers |
| **Orphaned API routes** | 1 | No UI caller found |

### Auth Protection

| Metric | Count | Status |
|--------|-------|--------|
| **Protected admin routes** | 6 | Check auth correctly |
| **Unprotected sensitive areas** | 0 | -- |

### E2E Flows

| Metric | Count | Status |
|--------|-------|--------|
| **Complete flows** | 2 | Work end-to-end |
| **Partially broken flows** | 1 | Have minor integration gaps |

---

## Cross-Phase Integration Verification

### 1. Phase 6 -> Phase 9: PDF -> Evidence Export [CONNECTED]

**Verified:** The evidence export service (src/services/evidence-export-service.ts lines 143-146) dynamically imports the SAME PDF modules used by the regular PDF route:

- evidence-export-service.ts and pdf/route.ts both import from @/lib/pdf/react-pdf-wrapper and @/lib/pdf/report-template
- Both use identical dynamic import pattern with Promise.all

**Data transformation match:** Both use the identical report data transformation pattern for scopeOfWorks, methodology, equipment, conclusions, expertDeclaration, roofElements, and complianceAssessment.

**Result:** The evidence export ZIP will contain a PDF with the Phase 6 MethodologySection (Section 3) and ComplianceAssessment (Section 7) because both come from the same ReportPDF component which imports MethodologySection at src/lib/pdf/report-template.tsx line 18 and renders it at line 1590.

**Status: FULLY CONNECTED**

---

### 2. Phase 6 -> Phase 9: PDF -> Batch PDF [CONNECTED]

**Verified:** The batch PDF endpoint (src/app/api/admin/reports/batch-pdf/route.ts lines 10-14) uses the same dynamic import pattern importing from @/lib/pdf/react-pdf-wrapper and @/lib/pdf/report-template.

**Data transformation match:** The generatePdfForReport function (lines 73-101) uses an identical transformation to the regular PDF route and the evidence export service, including methodology, equipment, and complianceAssessment fields.

**Query match:** The fetchReports function (lines 31-65) includes all required relations: inspector, photos, defects (with roofElement), roofElements (with photos), and complianceAssessment. This matches what MethodologySection and the compliance tables need.

**Status: FULLY CONNECTED**

---

### 3. Phase 7 -> Phase 9: Email -> Email Templates [PARTIALLY CONNECTED -- GAP FOUND]

**What exists:**
- Phase 7 hardcoded 8 email functions in src/lib/email.ts
- Phase 9 created src/services/email-template-service.ts with 8 matching default templates
- Phase 9 created admin UI for editing these templates with live preview

**Template type mapping (all 8 match correctly):**

| email.ts function | Template type | Match |
|---|---|---|
| sendReportSubmittedNotification | REPORT_SUBMITTED | YES |
| sendReportApprovedNotification | REPORT_APPROVED | YES |
| sendRevisionRequiredNotification | REVISION_REQUIRED | YES |
| sendReportRejectedNotification | REPORT_REJECTED | YES |
| sendReportFinalizedNotification | REPORT_FINALIZED | YES |
| sendNewCommentsNotification | NEW_COMMENTS | YES |
| sendAssignmentConfirmationEmail | ASSIGNMENT_CONFIRMATION | YES |
| sendInspectorAssignmentEmail | INSPECTOR_ASSIGNMENT | YES |

**GAP: emailTemplateService.renderTemplate() is NEVER CALLED by the notification-sending code.**

The renderTemplate method exists in src/services/email-template-service.ts (line 62) and is designed to look up DB templates first, then fall back to hardcoded defaults. However, src/lib/email.ts -- which is the file that actually sends notification emails -- does NOT import or use the email template service. All 7 API routes that send emails (assignments, review, submit, reject, comments, approve) import directly from src/lib/email.ts and use the hardcoded templates.

**Files that import from email.ts (hardcoded):**
- src/app/api/assignments/route.ts
- src/app/api/reports/[id]/review/route.ts
- src/app/api/reports/[id]/submit/route.ts
- src/app/api/reports/[id]/reject/route.ts
- src/app/api/reports/[id]/comments/route.ts
- src/app/api/reports/[id]/approve/route.ts

**Files that import emailTemplateService:**
- src/app/api/admin/email-templates/seed/route.ts (only uses getDefaultTemplates() for seeding)

**Impact:** Admins can edit email templates in the admin UI, but changes will have NO EFFECT on actual emails sent. The system will always use the hardcoded templates in email.ts. This is a design gap, not a crash bug.

**Status: DESIGN GAP -- Templates editable but not consumed by email senders**

---

### 4. Phase 7 -> Phase 9: Notifications -> Archive [CONNECTED]

**Verified:** The notification archive endpoint (src/app/api/admin/notifications/archive/route.ts lines 50-59) queries on fields that exist in the Notification model:
- read (Boolean, line 876 of schema)
- dismissed (Boolean, line 878 of schema)
- createdAt (DateTime, line 883 of schema)

All three fields match. Notifications created by Phase 7 wiring (via createAndPushNotification) will have read=false and dismissed=false by default. The archive endpoint correctly targets only read, non-dismissed notifications older than the threshold.

**Status: FULLY CONNECTED**

---

### 5. Phase 8 -> Phase 9: Filters -> Admin Reports [PARTIALLY CONNECTED -- MINOR GAP]

**Verified:** Phase 8 added filter parameters (severity, complianceStatus, inspectorId, dateField) to GET /api/reports and filter controls to ReportSearch.tsx. These work on the inspector-facing reports list page at src/app/(dashboard)/reports/page.tsx.

**Gap:** The admin reports page (src/app/(admin)/admin/reports/page.tsx) was refactored in Phase 9 to a Server Component + client content pattern. The server component fetches reports directly via prisma.report.findMany() with take: 100 -- but does NOT use any of Phase 8 filter parameters or ReportSearch.

**Impact:** Admin reports page shows a static list without filtering. Admins CAN use the inspector-facing /reports page for Phase 8 filters.

**Status: MINOR GAP -- Admin page lacks Phase 8 filter integration, but filters work on inspector reports page**


---

## E2E Flow Verification

### Flow 1: Inspector Report Flow [COMPLETE]

| Step | Component | Status | Evidence |
|------|-----------|--------|----------|
| 1. Create report | src/app/(dashboard)/reports/new/page.tsx | OK | POST /api/reports, 4-step wizard |
| 2. Fill methodology/equipment (P6) | src/app/(dashboard)/reports/[id]/edit/page.tsx | OK | Methodology textarea + equipment textarea with autosave |
| 3. Add defects/photos | Report editor wizard steps 4-5 | OK | Pre-existing functionality |
| 4. Submit for review | Submit endpoint | OK | Changes status to PENDING_REVIEW |
| 5. Reviewer gets notification (P7) | src/app/api/reports/[id]/submit/route.ts | OK | sendReportSubmittedNotification called |
| 6. Reviewer approves | src/app/api/reports/[id]/review/route.ts PATCH | OK | Status changes to APPROVED |
| 7. Inspector gets notification (P7) | Same route, lines 405-447 | OK | createAndPushNotification + sendReportApprovedNotification |
| 8. Report in filtered list (P8) | src/components/reports/ReportSearch.tsx | OK | Filters by severity, compliance, inspector, date |
| 9. Admin exports evidence ZIP (P9) | ExportEvidenceButton -> /api/reports/[id]/export -> EvidenceExportService | OK | Button on report detail for APPROVED/FINALISED reports |
| 10. Admin generates batch PDF (P9) | AdminReportsContent -> /api/admin/reports/batch-pdf | OK | Multi-select + batch generate |

**Status: COMPLETE -- All 10 steps verified with working connections**

---

### Flow 2: Admin Management Flow [COMPLETE with minor gap]

| Step | Component | Status | Evidence |
|------|-----------|--------|----------|
| 1. Navigate to admin panel | src/app/(admin)/admin/page.tsx | OK | Dashboard with stats and quick links |
| 2. View reports with filters (P8) | src/app/(admin)/admin/reports/page.tsx | PARTIAL | Shows reports but uses server-side fetch, NOT ReportSearch filters |
| 3. Select reports for batch PDF (P9) | admin-reports-content.tsx | OK | Checkboxes + select-all + confirmation dialog |
| 4. Manage email templates (P9) | src/app/(admin)/admin/email-templates/page.tsx | OK | List + seed defaults + edit links |
| 5. Archives old notifications (P9) | /api/admin/notifications/archive endpoint | OK | API exists and is protected |
| 6. View API documentation (P9) | src/app/(admin)/admin/api-docs/page.tsx | OK | Swagger UI fetches from /api/admin/docs |

**Navigation gap:** The admin dashboard page has 6 quick action cards linking to: Review Queue, LBP Complaints, User Management, Analytics, Templates, Audit Logs. It does NOT have quick links to Email Templates (/admin/email-templates) or API Documentation (/admin/api-docs). These pages exist and work, but users must navigate by URL.

**Status: COMPLETE with navigation gap -- all features work but 3 pages lack admin dashboard links**

---

### Flow 3: Template Workflow [COMPLETE]

| Step | Component | Status | Evidence |
|------|-----------|--------|----------|
| 1. Admin creates template | Pre-existing /admin/templates page | OK | CRUD API at /api/templates |
| 2. Inspector starts new report | src/app/(dashboard)/reports/new/page.tsx | OK | 4-step wizard |
| 3. Select template (P8) | TemplateSelector component in step 1 | OK | Fetches from GET /api/templates, renders cards |
| 4. Template pre-fills inspectionType | handleTemplateSelect (line 172-177) | OK | Updates formData.inspectionType immediately |
| 5. Template applies fields | After report creation (lines 132-139) | OK | Fire-and-forget POST to /api/templates/[id]/apply |
| 6. Inspector completes report | Report editor wizard | OK | Methodology/equipment fields available (P6) |
| 7. Report includes methodology in PDF (P6) | ReportPDF -> MethodologySection | OK | MethodologySection renders at line 1590 of report-template.tsx |

**Status: COMPLETE -- Full template-to-PDF pipeline verified**


---

## Detailed Findings

### Orphaned Exports

| Export | From | Reason |
|--------|------|--------|
| emailTemplateService.renderTemplate() | src/services/email-template-service.ts | Method exists and works, but is never called by any email-sending code. Only getDefaultTemplates() is used (by the seed endpoint). The template service was built as infrastructure but the final wire-up to replace hardcoded emails was not completed. |

### Missing Connections

| # | Expected Connection | From | To | Reason |
|---|---|---|---|---|
| 1 | Email template service used for sending | Phase 9 (email-template-service.ts) | Phase 7 (email.ts) | src/lib/email.ts does not import or call emailTemplateService.renderTemplate(). Edits to email templates in the admin UI have no effect on actual emails. |
| 2 | Admin dashboard links to email templates | Phase 9 admin pages | Admin dashboard page.tsx | /admin/email-templates page exists but admin dashboard has no quick link card for it. |
| 3 | Admin dashboard links to API docs | Phase 9 admin pages | Admin dashboard page.tsx | /admin/api-docs page exists but admin dashboard has no quick link card for it. |

### API Route Consumer Coverage

| API Route | Consumer | Status |
|-----------|----------|--------|
| GET /api/reports/[id]/export | ExportEvidenceButton.tsx | CONSUMED |
| POST /api/admin/reports/batch-pdf | admin-reports-content.tsx | CONSUMED |
| POST /api/admin/notifications/archive | No UI caller | API-ONLY (designed for cron/manual) |
| GET /api/admin/email-templates | admin/email-templates/page.tsx | CONSUMED |
| POST /api/admin/email-templates | admin/email-templates/page.tsx (create) | CONSUMED |
| GET /api/admin/email-templates/[id] | admin/email-templates/[id]/page.tsx | CONSUMED |
| PUT /api/admin/email-templates/[id] | admin/email-templates/[id]/page.tsx | CONSUMED |
| POST /api/admin/email-templates/seed | admin/email-templates/page.tsx | CONSUMED |
| GET /api/admin/docs | admin/api-docs/page.tsx | CONSUMED |
| GET /api/templates | TemplateSelector.tsx | CONSUMED |
| POST /api/templates/[id]/apply | reports/new/page.tsx | CONSUMED |

**Note on /api/admin/notifications/archive:** This endpoint is designed to be called by Vercel Cron (documented in source code comments) or manually by an admin via API tools. It has no admin UI button, which is acceptable for an automated cleanup task.

### Auth Protection Verification

All Phase 9 admin endpoints verified to check auth:

| Endpoint | Auth Check | Role Check |
|----------|-----------|------------|
| POST /api/admin/reports/batch-pdf | getAuthUser() | ADMIN, SUPER_ADMIN |
| POST /api/admin/notifications/archive | getAuthUser() | ADMIN, SUPER_ADMIN |
| GET /api/admin/email-templates | Via admin route group | Admin layout protection |
| GET /api/admin/docs | Via admin route group | Admin layout protection |
| GET /api/reports/[id]/export | getAuthUser() + rate limiting | Owner or REVIEWER/ADMIN/SUPER_ADMIN |

---

## Summary of Risk Items

### High Priority (affects user-facing functionality)

1. **Email Template Editing Has No Effect (P7 -> P9 gap)**
   - **File:** src/lib/email.ts does not import emailTemplateService
   - **Impact:** Admin can edit email templates in UI but changes are silently ignored; all emails use hardcoded templates
   - **Risk:** Admin confusion -- they may edit templates expecting changes to take effect
   - **Fix:** Wire emailTemplateService.renderTemplate() into the email sending functions in email.ts, or document that template editing is a future feature

### Medium Priority (UX gaps)

2. **Admin Dashboard Missing Navigation Links**
   - **File:** src/app/(admin)/admin/page.tsx (lines 179-298)
   - **Impact:** Email Templates, API Docs, and Admin Reports pages are accessible only by URL
   - **Fix:** Add quick action cards for Email Templates, API Docs, and All Reports to the admin dashboard

3. **Admin Reports Page Lacks Phase 8 Filters**
   - **File:** src/app/(admin)/admin/reports/page.tsx
   - **Impact:** Admin cannot filter reports on the admin reports page (can only see latest 100 sorted by date)
   - **Fix:** Either integrate ReportSearch component or add server-side filtering to the admin page

### Low Priority (acceptable design decisions)

4. **Notification Archive Has No UI Trigger**
   - **File:** src/app/api/admin/notifications/archive/route.ts
   - **Impact:** Notification archiving can only be triggered via API call or cron job
   - **Acceptable:** This is documented as cron-intended behaviour

---

## Conclusion

The cross-phase integration for v1.1 is **solid on the critical paths**. The core flows -- PDF generation with methodology sections, evidence export with full PDF, batch PDF processing, notification wiring, template selection, and shared report protection -- all work end-to-end with verified connections.

The single significant integration gap is the email template service not being wired into the actual email-sending code. This is a design gap rather than a functional break: emails will send correctly using hardcoded templates, but admin template edits will have no effect. This should be documented for admins or fixed before UAT.

The navigation and filtering gaps on the admin pages are minor UX issues that do not affect core functionality.

**Overall Integration Status: PASS with 1 documented gap**
