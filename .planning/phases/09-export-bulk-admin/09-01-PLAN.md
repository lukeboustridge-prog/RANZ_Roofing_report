---
phase: 09-export-bulk-admin
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/evidence-export-service.ts
  - src/app/api/reports/[id]/export/route.ts
  - src/app/(dashboard)/reports/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can click an 'Export Evidence Package' button on a report detail page"
    - "Clicking export generates a ZIP file containing the report PDF, original photos, and chain of custody certificate"
    - "The ZIP includes a manifest.json with report metadata and file listing"
    - "The export returns a download URL and SHA-256 hash for integrity verification"
  artifacts:
    - path: "src/services/evidence-export-service.ts"
      provides: "Evidence package ZIP generation with PDF, photos, chain of custody, manifest"
      min_lines: 100
    - path: "src/app/api/reports/[id]/export/route.ts"
      provides: "GET endpoint that triggers evidence package creation and returns download URL"
      exports: ["GET"]
    - path: "src/app/(dashboard)/reports/[id]/page.tsx"
      provides: "Export Evidence Package button in report detail page"
  key_links:
    - from: "src/app/(dashboard)/reports/[id]/page.tsx"
      to: "/api/reports/[id]/export"
      via: "fetch call on button click"
      pattern: "fetch.*api/reports.*export"
    - from: "src/services/evidence-export-service.ts"
      to: "src/lib/r2.ts"
      via: "uploadToR2 for ZIP storage"
      pattern: "uploadToR2"
    - from: "src/services/evidence-export-service.ts"
      to: "src/lib/pdf/react-pdf-wrapper.ts"
      via: "dynamic import for PDF generation"
      pattern: "import.*react-pdf-wrapper"
---

<objective>
Create the evidence package ZIP export feature that packages a report's PDF, original photos, and chain of custody documentation into a downloadable ZIP file.

Purpose: Court and tribunal submissions require a complete evidence package with all supporting documents. This enables users to export everything in one download with integrity verification.
Output: Working evidence export service, API endpoint, and UI button on report detail page.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key reference files
@src/services/lbp-evidence-package-service.ts  # Existing ZIP pattern to generalize from
@src/app/api/reports/[id]/pdf/route.ts          # PDF generation pattern with dynamic imports
@src/lib/pdf/react-pdf-wrapper.ts               # PDF module wrapper
@src/lib/r2.ts                                  # R2 upload utility
@src/app/(dashboard)/reports/[id]/page.tsx       # Report detail page to add button to
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create evidence export service and API endpoint</name>
  <files>
    src/services/evidence-export-service.ts
    src/app/api/reports/[id]/export/route.ts
  </files>
  <action>
    Create `src/services/evidence-export-service.ts` by generalizing the pattern from `src/services/lbp-evidence-package-service.ts` for general reports (not just LBP complaints):

    1. Create an `EvidenceExportService` class with a `createExportPackage(reportId: string)` method that:
       - Fetches the report with photos, defects, inspector, roofElements, and complianceAssessment (same includes as the PDF route)
       - Uses JSZip (already in package.json) to create a ZIP containing:
         a. Report PDF: Generate using dynamic import of `@/lib/pdf/react-pdf-wrapper` and `@/lib/pdf/report-template` (copy the exact transform logic from the PDF route for reportData)
         b. Original photos folder: Fetch each photo from its URL, name them `{index}_{photoType}_{caption}.{ext}` (sanitize caption)
         c. Photo metadata JSON: `_photo_metadata.json` with hash, GPS, timestamps, camera info for each photo
         d. Chain of custody document: `chain_of_custody.txt` documenting evidence collection, processing, and standards compliance (ISO 17020, NZ Evidence Act 2006)
         e. Manifest: `manifest.json` with reportNumber, exportDate, photoCount, defectCount, file listing
       - Generates ZIP with DEFLATE compression (level 6 for speed/size balance)
       - Calculates SHA-256 hash of the ZIP buffer
       - Uploads ZIP to R2 using `uploadToR2` at path `exports/{reportNumber}.zip`
       - Returns `{ url: string, hash: string, filename: string }`

    2. Create `src/app/api/reports/[id]/export/route.ts` with a GET endpoint:
       - Auth check using `getAuthUser` + `getUserWhereClause` pattern (same as PDF route)
       - Rate limit using `RATE_LIMIT_PRESETS.pdf` (exports are expensive like PDFs)
       - Verify user is report owner or REVIEWER/ADMIN/SUPER_ADMIN
       - Call `evidenceExportService.createExportPackage(id)`
       - Return JSON with `{ url, hash, filename }`
       - Create audit log entry with action "EVIDENCE_EXPORTED"

    Important: Use the EXACT same dynamic import pattern as the PDF route to avoid build issues with @react-pdf/renderer. Use `import("@/lib/pdf/react-pdf-wrapper")` and `import("@/lib/pdf/report-template")` inside the method, NOT at module top level.

    Do NOT import from `@/lib/constants/lbp` -- that's LBP-specific. Use RANZ details directly or from a general constants file.
  </action>
  <verify>
    - `npx tsc --noEmit` passes (no type errors in new files)
    - `src/services/evidence-export-service.ts` exists with EvidenceExportService class
    - `src/app/api/reports/[id]/export/route.ts` exports GET function
    - Service imports JSZip, uses uploadToR2, has SHA-256 hash generation
  </verify>
  <done>
    Evidence export service creates ZIP with PDF + photos + chain of custody + manifest. API endpoint authenticates, rate-limits, calls service, returns download URL and hash.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Export Evidence Package button to report detail page</name>
  <files>
    src/app/(dashboard)/reports/[id]/page.tsx
  </files>
  <action>
    Add an "Export Evidence Package" button to the report detail page:

    1. Read the existing report detail page to understand its structure and patterns.

    2. Add an export button (Download icon + "Export Evidence Package" text) in the actions area of the report detail page, near existing action buttons (e.g., Generate PDF, Share).

    3. The button should:
       - Only be visible for reports with status APPROVED or FINALIZED (evidence packages only make sense for complete reports)
       - Show a loading state (spinner) while export is in progress
       - Call `GET /api/reports/${reportId}/export` on click
       - On success: Open the returned URL in a new tab for download, show a success toast with the filename
       - On error: Show an error toast with the error message
       - Use the same button styling pattern as other action buttons on the page

    4. Use the `Package` or `FileArchive` icon from lucide-react for the export button.

    5. If the page uses a separate content component (e.g., `*-content.tsx`), add the button there instead. Follow whichever pattern the page already uses.
  </action>
  <verify>
    - Report detail page renders without errors
    - Export button is present in the page's action area
    - Button has click handler that fetches from /api/reports/[id]/export
    - Loading state is handled
  </verify>
  <done>
    Report detail page shows "Export Evidence Package" button for approved/finalized reports. Clicking it triggers ZIP generation and opens the download URL.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Evidence export service file exists at `src/services/evidence-export-service.ts`
3. API route exists at `src/app/api/reports/[id]/export/route.ts`
4. Report detail page includes Export Evidence Package button
5. Service uses JSZip, R2 upload, SHA-256 hashing
6. API route has auth, rate limiting, and audit logging
</verification>

<success_criteria>
- User can click "Export Evidence Package" on an approved/finalized report
- The export generates a ZIP containing: report PDF, original photos, chain of custody, manifest
- The ZIP is uploaded to R2 and a download URL is returned
- SHA-256 hash is generated for integrity verification
- Proper authentication, authorization, and rate limiting are enforced
</success_criteria>

<output>
After completion, create `.planning/phases/09-export-bulk-admin/09-01-SUMMARY.md`
</output>
