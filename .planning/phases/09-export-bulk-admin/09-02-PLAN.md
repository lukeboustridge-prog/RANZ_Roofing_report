---
phase: 09-export-bulk-admin
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/admin/reports/batch-pdf/route.ts
  - src/app/api/admin/notifications/archive/route.ts
  - src/app/(admin)/admin/reports/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can select multiple reports and generate PDFs for all of them in a single batch operation"
    - "Batch PDF generation processes reports in groups of 5 and returns success/failure counts"
    - "Notifications older than a configurable threshold are automatically archived and no longer appear in the active notification list"
    - "Admin can trigger notification archiving manually via an API endpoint"
  artifacts:
    - path: "src/app/api/admin/reports/batch-pdf/route.ts"
      provides: "POST endpoint for bulk PDF generation with batching"
      exports: ["POST"]
    - path: "src/app/api/admin/notifications/archive/route.ts"
      provides: "POST endpoint for archiving old notifications"
      exports: ["POST"]
    - path: "src/app/(admin)/admin/reports/page.tsx"
      provides: "Batch Generate PDFs button in admin reports list"
  key_links:
    - from: "src/app/api/admin/reports/batch-pdf/route.ts"
      to: "src/lib/pdf/react-pdf-wrapper.ts"
      via: "dynamic import for PDF generation per report"
      pattern: "import.*react-pdf-wrapper"
    - from: "src/app/api/admin/notifications/archive/route.ts"
      to: "prisma.notification.updateMany"
      via: "bulk update setting dismissed=true"
      pattern: "notification\\.updateMany"
    - from: "src/app/(admin)/admin/reports/page.tsx"
      to: "/api/admin/reports/batch-pdf"
      via: "fetch on batch generate button click"
      pattern: "fetch.*batch-pdf"
---

<objective>
Create bulk PDF generation for admin and notification auto-archiving. These are the two backend admin operation features for Phase 9.

Purpose: Admins need to generate PDFs for multiple reports at once instead of one at a time. Old notifications need to be cleaned up to keep the notification list relevant.
Output: Batch PDF generation endpoint with admin UI, notification archive endpoint.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key reference files
@src/app/api/admin/reports/batch/route.ts        # Existing batch operations pattern (approve/reject/archive)
@src/app/api/reports/[id]/pdf/route.ts            # PDF generation with dynamic imports
@src/lib/pdf/react-pdf-wrapper.ts                 # PDF module wrapper
@src/app/(admin)/admin/reports/page.tsx            # Admin reports page to add batch PDF button
@src/lib/notifications/push-service.ts            # Notification system reference
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create batch PDF generation endpoint and notification archive endpoint</name>
  <files>
    src/app/api/admin/reports/batch-pdf/route.ts
    src/app/api/admin/notifications/archive/route.ts
  </files>
  <action>
    **1. Batch PDF Generation (`src/app/api/admin/reports/batch-pdf/route.ts`)**

    Create a POST endpoint that accepts `{ reportIds: string[] }` and generates PDFs for all specified reports:

    - Auth: Require ADMIN or SUPER_ADMIN role (same pattern as `src/app/api/admin/reports/batch/route.ts`)
    - Validate reportIds is a non-empty array, max 50 reports per request
    - Fetch all reports in a single Prisma query with the same includes as the PDF route (inspector, photos with sortOrder, defects with photos and roofElement, roofElements with photos, complianceAssessment)
    - Process in batches of 5 using Promise.allSettled:
      ```
      for (let i = 0; i < reports.length; i += BATCH_SIZE) {
        const batch = reports.slice(i, i + BATCH_SIZE);
        const batchResults = await Promise.allSettled(
          batch.map(report => generatePdfForReport(report))
        );
        results.push(...batchResults);
      }
      ```
    - For each report, use the EXACT same dynamic import and data transformation pattern from `src/app/api/reports/[id]/pdf/route.ts` (the reportData transform with scopeOfWorks, methodology, equipment, conclusions, expertDeclaration, roofElements, complianceAssessment)
    - Update `pdfGeneratedAt` for successful reports using `prisma.report.updateMany`
    - Create audit log entries for each successful PDF generation
    - Return JSON: `{ successful: number, failed: number, results: Array<{ id: string, reportNumber: string, success: boolean, error?: string }> }`

    **2. Notification Archive (`src/app/api/admin/notifications/archive/route.ts`)**

    Create a POST endpoint that archives old read notifications:

    - Auth: Require ADMIN or SUPER_ADMIN role
    - Accept optional body `{ thresholdDays?: number }` (default: 30, read from `process.env.NOTIFICATION_ARCHIVE_DAYS` as fallback)
    - Calculate cutoff date: `new Date() - thresholdDays`
    - Use `prisma.notification.updateMany` to set `dismissed: true` for notifications WHERE:
      - `read: true` (only archive read notifications)
      - `createdAt < cutoffDate` (older than threshold)
      - `dismissed: false` (not already archived)
    - Return JSON: `{ archived: number, thresholdDays: number, cutoffDate: string }`
    - Log the operation: `console.log([Notification Archive] Archived ${count} notifications older than ${thresholdDays} days)`

    This endpoint can also be called by Vercel Cron or a scheduled job. Add a comment noting this.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Both route files exist and export POST functions
    - Batch PDF route has BATCH_SIZE = 5 and Promise.allSettled pattern
    - Archive route uses prisma.notification.updateMany with read + createdAt + dismissed conditions
  </verify>
  <done>
    Batch PDF endpoint generates PDFs in groups of 5, returns success/failure counts. Notification archive endpoint soft-deletes old read notifications past configurable threshold.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add batch PDF generation button to admin reports page</name>
  <files>
    src/app/(admin)/admin/reports/page.tsx
  </files>
  <action>
    Read the existing admin reports page to understand its structure. Then add batch PDF generation capability:

    1. If the page has a separate content component (*-content.tsx), modify that instead. Follow existing patterns.

    2. Add report selection capability:
       - Add checkboxes to each report row (if not already present from existing batch operations)
       - Add a "Select All" checkbox in the header
       - Track selected report IDs in state

    3. Add a "Generate PDFs" button in the action bar (alongside any existing batch action buttons):
       - Disable when no reports are selected
       - Show count of selected reports: "Generate PDFs (N)"
       - Use the `FileText` or `Files` icon from lucide-react

    4. On click:
       - Show confirmation dialog: "Generate PDFs for N reports? This may take a moment."
       - POST to `/api/admin/reports/batch-pdf` with `{ reportIds: selectedIds }`
       - Show loading state with spinner
       - On success: Show success toast with "Generated N PDFs successfully" (include failure count if any)
       - On error: Show error toast
       - Clear selection and refresh the report list after completion

    5. If the page already has batch selection (from the existing batch operations feature at `/api/admin/reports/batch`), reuse that selection state and add the "Generate PDFs" button alongside existing batch action buttons.

    NOTE: The admin reports page and admin layout use 'use client' -- this is expected per accumulated decisions.
  </action>
  <verify>
    - Admin reports page renders without errors
    - Batch PDF button appears when reports are selected
    - Button sends POST to /api/admin/reports/batch-pdf with selected IDs
    - Success/error feedback is shown via toast
  </verify>
  <done>
    Admin can select multiple reports on the admin reports page and click "Generate PDFs" to trigger batch generation. Progress and results are displayed.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Batch PDF route exists at `src/app/api/admin/reports/batch-pdf/route.ts`
3. Notification archive route exists at `src/app/api/admin/notifications/archive/route.ts`
4. Admin reports page has batch PDF generation button with selection capability
5. Batch PDF uses batches of 5 with Promise.allSettled
6. Notification archive uses soft delete (dismissed=true) with configurable threshold
</verification>

<success_criteria>
- Admin can select multiple reports and generate PDFs in batch
- Batch processing uses groups of 5 to avoid memory exhaustion
- Results show success/failure counts per report
- Notification archive sets dismissed=true for old, read notifications
- Archive threshold is configurable (default 30 days)
- Both endpoints require ADMIN/SUPER_ADMIN auth
</success_criteria>

<output>
After completion, create `.planning/phases/09-export-bulk-admin/09-02-SUMMARY.md`
</output>
