---
phase: 09-export-bulk-admin
plan: 04
type: execute
wave: 2
depends_on: ["09-03"]
files_modified:
  - src/app/(admin)/admin/email-templates/page.tsx
  - src/app/(admin)/admin/email-templates/[id]/page.tsx
  - src/app/api/admin/docs/route.ts
  - src/app/(admin)/admin/api-docs/page.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Admin can view a list of all email templates from the admin panel"
    - "Admin can edit an email template's subject and body content with live preview"
    - "An OpenAPI/Swagger specification is accessible at an API endpoint"
    - "Admin can view API documentation via a Swagger UI page"
  artifacts:
    - path: "src/app/(admin)/admin/email-templates/page.tsx"
      provides: "Admin email template list page"
      min_lines: 30
    - path: "src/app/(admin)/admin/email-templates/[id]/page.tsx"
      provides: "Admin email template editor with preview"
      min_lines: 50
    - path: "src/app/api/admin/docs/route.ts"
      provides: "GET endpoint returning OpenAPI spec JSON"
      exports: ["GET"]
    - path: "src/app/(admin)/admin/api-docs/page.tsx"
      provides: "Swagger UI page for API documentation"
      min_lines: 20
  key_links:
    - from: "src/app/(admin)/admin/email-templates/page.tsx"
      to: "/api/admin/email-templates"
      via: "fetch for template list"
      pattern: "fetch.*admin/email-templates"
    - from: "src/app/(admin)/admin/email-templates/[id]/page.tsx"
      to: "/api/admin/email-templates/[id]"
      via: "fetch for template detail + PUT for updates"
      pattern: "fetch.*admin/email-templates"
    - from: "src/app/(admin)/admin/api-docs/page.tsx"
      to: "/api/admin/docs"
      via: "fetch for OpenAPI spec"
      pattern: "fetch.*admin/docs"
---

<objective>
Create admin UI pages for email template management and API documentation viewer.

Purpose: Admins need a visual interface to view and edit email templates. Developers need API documentation accessible from the admin panel.
Output: Email template list page, template editor with preview, OpenAPI spec endpoint, Swagger UI page.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summary needed for EmailTemplate model
@.planning/phases/09-export-bulk-admin/09-03-SUMMARY.md

# Key reference files
@src/app/(admin)/admin/templates/page.tsx          # Existing admin template page for UI patterns
@src/app/(admin)/admin/settings/page.tsx           # Admin settings page for layout patterns
@src/app/api/admin/email-templates/route.ts        # Email template API routes (from Plan 03)
@src/app/api/admin/email-templates/[id]/route.ts   # Email template detail route (from Plan 03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email template admin pages (list + editor)</name>
  <files>
    src/app/(admin)/admin/email-templates/page.tsx
    src/app/(admin)/admin/email-templates/[id]/page.tsx
  </files>
  <action>
    Create admin pages for email template management. Follow the existing admin page patterns (check `src/app/(admin)/admin/templates/page.tsx` or `src/app/(admin)/admin/settings/page.tsx` for layout and styling patterns). Admin layouts are 'use client' per accumulated decisions.

    **1. Template List Page (`src/app/(admin)/admin/email-templates/page.tsx`)**

    - Fetch templates from GET `/api/admin/email-templates` on mount
    - Display as a table or card grid with columns: Name, Type, Subject, Active status, Last updated
    - Each row/card links to the edit page: `/admin/email-templates/{id}`
    - Add a "Seed Defaults" button that calls POST `/api/admin/email-templates/seed` (for initial setup when no templates exist yet). Only show if template list is empty.
    - Show loading skeleton while fetching
    - If using the dynamic import pattern (thin page.tsx + *-content.tsx), follow that pattern

    **2. Template Editor Page (`src/app/(admin)/admin/email-templates/[id]/page.tsx`)**

    - Fetch template from GET `/api/admin/email-templates/{id}` on mount
    - Display editable form with:
      a. **Name** (read-only display)
      b. **Type** (read-only display, e.g., "REPORT_APPROVED")
      c. **Subject** - text input with {{variable}} support
      d. **HTML Body** - textarea (large, monospace font) with {{variable}} support
      e. **Plain Text Body** - textarea with {{variable}} support
      f. **Active** toggle (boolean)
      g. **Available Variables** panel - show the template's `variables` JSON as a reference list so admins know which {{variables}} they can use
    - Add a "Preview" section below the editor:
      - Renders the HTML body in an iframe or dangerouslySetInnerHTML div (sandboxed)
      - Use sample data to substitute variables for the preview
    - Save button: PUT to `/api/admin/email-templates/{id}` with updated fields
    - Show success/error toast on save
    - Back button to return to template list
    - Use React Hook Form for form state management if other admin pages use it, otherwise useState is fine
  </action>
  <verify>
    - Both admin pages render without errors
    - Template list page fetches and displays templates
    - Template editor page shows editable form with subject, HTML body, text body
    - Preview section renders HTML with sample variable substitution
    - Save button calls PUT endpoint
  </verify>
  <done>
    Admin can view all email templates in a list, click into any template to edit its subject, HTML body, and plain text body. A preview shows the rendered email. Changes save via API.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OpenAPI spec endpoint and Swagger UI page</name>
  <files>
    src/app/api/admin/docs/route.ts
    src/app/(admin)/admin/api-docs/page.tsx
    package.json
  </files>
  <action>
    **1. Install swagger-ui-react**

    Run `npm install swagger-ui-react` and `npm install -D @types/swagger-ui-react` (if types package exists; if not, create a minimal type declaration).

    Do NOT install next-swagger-doc -- we will write a manual OpenAPI spec since auto-generation from App Router is unreliable and the app has 88 routes that would need JSDoc annotations. A manual spec covering the key endpoints is more practical.

    **2. Create OpenAPI spec endpoint (`src/app/api/admin/docs/route.ts`)**

    - Auth: Require ADMIN or SUPER_ADMIN role
    - Return a hand-crafted OpenAPI 3.0 JSON spec covering the main API endpoint groups:
      - `/api/reports` - CRUD operations (GET list, POST create)
      - `/api/reports/[id]` - GET, PUT, DELETE
      - `/api/reports/[id]/pdf` - GET (PDF generation)
      - `/api/reports/[id]/export` - GET (evidence package export)
      - `/api/admin/reports/batch` - POST (batch operations)
      - `/api/admin/reports/batch-pdf` - POST (batch PDF generation)
      - `/api/admin/email-templates` - GET, POST
      - `/api/admin/email-templates/[id]` - GET, PUT
      - `/api/admin/notifications/archive` - POST
    - Include:
      - `info`: title "RANZ Roofing Report API", version "1.0.0", description
      - `servers`: production (https://reports.ranz.org.nz), development (http://localhost:3000)
      - `components.securitySchemes`: bearerAuth (Clerk JWT)
      - For each endpoint: method, summary, description, request body schema (if applicable), response schemas (200, 401, 403, 500)
    - The spec doesn't need to be exhaustive for all 88 routes -- focus on the key admin and report endpoints. It's a living document.

    **3. Create Swagger UI page (`src/app/(admin)/admin/api-docs/page.tsx`)**

    - 'use client' page (admin layout is client)
    - Use dynamic import for swagger-ui-react: `const SwaggerUI = dynamic(() => import('swagger-ui-react'), { ssr: false })`
    - Import swagger-ui-react CSS (check if it ships CSS or needs a CDN link: `import 'swagger-ui-react/swagger-ui.css'`)
    - Fetch the spec from `/api/admin/docs` on mount
    - Pass spec JSON to SwaggerUI component: `<SwaggerUI spec={spec} />`
    - Show loading state while spec is being fetched
    - Add page title: "API Documentation"
    - Style container to fit within admin layout
  </action>
  <verify>
    - `npm ls swagger-ui-react` shows it installed
    - `npx tsc --noEmit` passes (or at least new files have no errors)
    - API docs route at `/api/admin/docs` returns valid OpenAPI JSON
    - Admin API docs page renders SwaggerUI component
    - Spec includes at least 5 endpoint groups with schemas
  </verify>
  <done>
    OpenAPI spec is served at /api/admin/docs with key endpoint documentation. Swagger UI page at /admin/api-docs renders interactive API documentation for admin users.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Email template list page exists at `src/app/(admin)/admin/email-templates/page.tsx`
3. Email template editor page exists at `src/app/(admin)/admin/email-templates/[id]/page.tsx`
4. API docs route exists at `src/app/api/admin/docs/route.ts`
5. Swagger UI page exists at `src/app/(admin)/admin/api-docs/page.tsx`
6. swagger-ui-react is installed in package.json
7. Template editor has working preview and save functionality
8. OpenAPI spec covers key endpoint groups
</verification>

<success_criteria>
- Admin can browse email templates and click into an editor
- Template editor shows subject, HTML body, text body, available variables, and live preview
- Admin can save template changes
- OpenAPI spec is generated and served at admin-protected endpoint
- Swagger UI renders interactive documentation at /admin/api-docs
- Both features require ADMIN/SUPER_ADMIN auth
</success_criteria>

<output>
After completion, create `.planning/phases/09-export-bulk-admin/09-04-SUMMARY.md`
</output>
