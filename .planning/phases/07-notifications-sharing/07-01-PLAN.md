---
phase: 07-notifications-sharing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/assignments/route.ts
  - src/lib/email.ts
autonomous: true

must_haves:
  truths:
    - "Client receives a confirmation email when their inspection request (assignment) is created"
    - "Inspector receives an in-app notification when assigned to an inspection"
    - "Inspector receives an email when assigned to an inspection"
    - "Notification failures do not break assignment creation"
  artifacts:
    - path: "src/app/api/assignments/route.ts"
      provides: "Assignment creation with notification triggers"
      contains: "createAndPushNotification"
    - path: "src/lib/email.ts"
      provides: "Client confirmation and inspector assignment email templates"
      contains: "sendAssignmentConfirmationEmail"
  key_links:
    - from: "src/app/api/assignments/route.ts"
      to: "src/lib/notifications/push-service.ts"
      via: "createAndPushNotification import and call"
      pattern: "createAndPushNotification\\(inspector"
    - from: "src/app/api/assignments/route.ts"
      to: "src/lib/email.ts"
      via: "sendEmail/sendAssignment* import and call"
      pattern: "send.*Email|send.*Notification"
---

<objective>
Wire notification triggers into the assignment creation endpoint so that clients receive a confirmation email and inspectors receive both in-app + push notification and an email when a new inspection assignment is created.

Purpose: Completes NOTIF-01 (client confirmation email) and NOTIF-02 (inspector assignment notification) by connecting the existing notification infrastructure to the assignment creation workflow.
Output: Modified assignment route with notification triggers; new email templates for client confirmation and inspector assignment.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-notifications-sharing/07-RESEARCH.md

Key source files:
@src/app/api/assignments/route.ts
@src/lib/email.ts
@src/lib/notifications/push-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add client confirmation and inspector assignment email templates</name>
  <files>src/lib/email.ts</files>
  <action>
Add two new exported email template functions to src/lib/email.ts, following the exact pattern of existing templates (sendReportSubmittedNotification, sendReportApprovedNotification, etc.):

1. `sendAssignmentConfirmationEmail(clientEmail: string, details: AssignmentDetails): Promise<SendResult>`
   - Purpose: Confirms to the client that their inspection request has been received
   - AssignmentDetails interface: { clientName: string; propertyAddress: string; inspectorName: string; requestType: string; urgency: string; scheduledDate?: string; }
   - Subject: `Inspection Request Confirmed - ${details.propertyAddress}`
   - HTML content using wrapInTemplate():
     - Heading: "Inspection Request Confirmed" (color: #2d5c8f)
     - Body: "Dear ${clientName}, your inspection request has been received and an inspector has been assigned."
     - Details card (white bg, border): Property address, request type (formatted: replace _ with space), urgency level, scheduled date (if provided), inspector name
     - Closing: "Your inspector will be in contact to arrange access. If you have questions, please contact RANZ."
   - Plain text fallback with same info

2. `sendInspectorAssignmentEmail(inspectorEmail: string, details: InspectorAssignmentDetails): Promise<SendResult>`
   - Purpose: Notifies inspector of new assignment via email
   - InspectorAssignmentDetails interface: { inspectorName: string; clientName: string; clientEmail: string; propertyAddress: string; requestType: string; urgency: string; scheduledDate?: string; assignmentUrl: string; notes?: string; }
   - Subject: `[New Assignment] ${details.propertyAddress} - ${details.requestType.replace(/_/g, ' ')}`
   - HTML content using wrapInTemplate():
     - Heading: "New Inspection Assignment" (color: #2d5c8f)
     - Body: "You have been assigned a new inspection."
     - Details card: Property address, client name, request type, urgency, scheduled date (if set), notes (if provided)
     - CTA button (bg: #2d5c8f): "View Assignment" linking to assignmentUrl
   - Plain text fallback

Both functions must use the existing wrapInTemplate() and sendEmail() functions. Do NOT modify existing template functions.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root -- no new type errors in src/lib/email.ts. Grep for "sendAssignmentConfirmationEmail" and "sendInspectorAssignmentEmail" in the file to confirm they exist and are exported.
  </verify>
  <done>
Two new exported email template functions exist in src/lib/email.ts with proper types, HTML templates using wrapInTemplate(), and plain text fallbacks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire notification triggers into assignment creation endpoint</name>
  <files>src/app/api/assignments/route.ts</files>
  <action>
Modify the POST handler in src/app/api/assignments/route.ts to add notification triggers AFTER the successful assignment creation (after line 172 where assignment is created, before the return on line 174).

Add these imports at the top of the file:
```typescript
import { createAndPushNotification } from "@/lib/notifications/push-service";
import { sendAssignmentConfirmationEmail, sendInspectorAssignmentEmail } from "@/lib/email";
```

After the assignment is created (after `const assignment = await prisma.assignment.create({...})`) and BEFORE the return statement, add three non-blocking notification calls. Use .catch() on ALL notification calls so failures never break assignment creation (following the established pattern from submit/route.ts and approve/route.ts):

1. **In-app + push notification to inspector** (NOTIF-02):
```typescript
createAndPushNotification(data.inspectorId, {
  type: "NEW_ASSIGNMENT",
  title: "New Inspection Assignment",
  message: `Inspection requested for ${data.propertyAddress}`,
  link: `/assignments/${assignment.id}`,
  assignmentId: assignment.id,
  metadata: {
    urgency: data.urgency,
    requestType: data.requestType,
  },
}).catch(err => {
  console.error("[Assignment] Failed to send in-app notification:", err);
});
```

2. **Email to inspector** (NOTIF-02):
```typescript
const baseUrl = process.env.NEXT_PUBLIC_APP_URL || "https://reports.ranz.org.nz";
sendInspectorAssignmentEmail(inspector.email, {
  inspectorName: inspector.name || "Inspector",
  clientName: data.clientName,
  clientEmail: data.clientEmail,
  propertyAddress: data.propertyAddress,
  requestType: data.requestType,
  urgency: data.urgency,
  scheduledDate: data.scheduledDate || undefined,
  assignmentUrl: `${baseUrl}/assignments/${assignment.id}`,
  notes: data.notes || undefined,
}).catch(err => {
  console.error("[Assignment] Failed to send inspector email:", err);
});
```

3. **Confirmation email to client** (NOTIF-01):
```typescript
sendAssignmentConfirmationEmail(data.clientEmail, {
  clientName: data.clientName,
  propertyAddress: data.propertyAddress,
  inspectorName: inspector.name || "RANZ Inspector",
  requestType: data.requestType,
  urgency: data.urgency,
  scheduledDate: data.scheduledDate || undefined,
}).catch(err => {
  console.error("[Assignment] Failed to send client confirmation:", err);
});
```

IMPORTANT: All three calls use .catch() and are NOT awaited. This prevents notification failures from blocking or breaking the assignment creation response. The assignment already returns 201 before notifications complete.

Do NOT modify the GET handler or the validation schema. Do NOT change the assignment creation query or its return value.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root -- no type errors. Grep src/app/api/assignments/route.ts for:
- "createAndPushNotification" (must appear)
- "sendAssignmentConfirmationEmail" (must appear)
- "sendInspectorAssignmentEmail" (must appear)
- ".catch" (must appear 3 times for the 3 notification calls)
  </verify>
  <done>
POST /api/assignments creates assignment AND triggers: (1) in-app + push notification to inspector, (2) email to inspector, (3) confirmation email to client. All notification calls are non-blocking with .catch() error handling.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no new errors
2. src/lib/email.ts exports sendAssignmentConfirmationEmail and sendInspectorAssignmentEmail
3. src/app/api/assignments/route.ts imports and calls createAndPushNotification, sendAssignmentConfirmationEmail, sendInspectorAssignmentEmail
4. All notification calls use .catch() pattern (non-blocking)
5. Assignment creation still returns 201 with the assignment object (unchanged response)
</verification>

<success_criteria>
- NOTIF-01: Assignment creation triggers client confirmation email via sendAssignmentConfirmationEmail
- NOTIF-02: Assignment creation triggers inspector in-app notification (createAndPushNotification with NEW_ASSIGNMENT type) AND inspector email (sendInspectorAssignmentEmail)
- All notification calls are fire-and-forget with .catch() error handling
- No regressions: assignment CRUD still works, TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/07-notifications-sharing/07-01-SUMMARY.md`
</output>
