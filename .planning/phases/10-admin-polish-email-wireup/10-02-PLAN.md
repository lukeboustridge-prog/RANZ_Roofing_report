---
phase: 10-admin-polish-email-wireup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(admin)/admin/page.tsx
  - src/app/(admin)/admin/reports/page.tsx
  - src/app/(admin)/admin/reports/admin-reports-content.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Admin dashboard shows quick action cards for Email Templates, API Docs, and All Reports"
    - "Admin reports page supports filtering by severity, compliance status, inspector, and date range"
    - "Admin can select individual reports or all reports for batch PDF generation via a collapsible checklist"
  artifacts:
    - path: "src/app/(admin)/admin/page.tsx"
      provides: "9 quick action cards (6 existing + 3 new)"
      contains: "email-templates"
    - path: "src/app/(admin)/admin/reports/page.tsx"
      provides: "Admin reports page with ReportSearch and batch PDF panel"
      contains: "ReportSearch"
    - path: "src/app/(admin)/admin/reports/admin-reports-content.tsx"
      provides: "Self-contained batch PDF panel with collapsible report checklist"
      contains: "handleGeneratePdfs"
  key_links:
    - from: "src/app/(admin)/admin/page.tsx"
      to: "/admin/email-templates"
      via: "Link href"
      pattern: "href.*admin/email-templates"
    - from: "src/app/(admin)/admin/page.tsx"
      to: "/admin/api-docs"
      via: "Link href"
      pattern: "href.*admin/api-docs"
    - from: "src/app/(admin)/admin/reports/page.tsx"
      to: "src/components/reports/ReportSearch.tsx"
      via: "component import"
      pattern: "import.*ReportSearch"
    - from: "src/app/(admin)/admin/reports/admin-reports-content.tsx"
      to: "/api/admin/reports/batch-pdf"
      via: "fetch POST"
      pattern: "fetch.*batch-pdf"
---

<objective>
Add 3 missing quick action cards to the admin dashboard and replace the admin reports page with the full-featured ReportSearch component while preserving batch PDF generation with a self-contained selection mechanism.

Purpose: Admin dashboard is missing navigation links to Email Templates, API Docs, and All Reports. Admin reports page lacks the filtering capabilities that ReportSearch already provides (severity, compliance, inspector, date range). Batch PDF generation needs a proper report selection UI.

Output: Admin dashboard with 9 quick action cards. Admin reports page using ReportSearch for full filtering + a self-contained BatchPdfPanel with collapsible report checklist for individual/bulk selection and PDF generation.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-admin-polish-email-wireup/10-RESEARCH.md

Key source files:
@src/app/(admin)/admin/page.tsx
@src/app/(admin)/admin/reports/page.tsx
@src/app/(admin)/admin/reports/admin-reports-content.tsx
@src/components/reports/ReportSearch.tsx (first 50 lines for import reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 3 quick action cards to admin dashboard</name>
  <files>src/app/(admin)/admin/page.tsx</files>
  <action>
Modify `src/app/(admin)/admin/page.tsx`:

1. **Update lucide-react imports** (line 8-19): Add `Mail` and `Code` to the import list. `FileText` is already imported. Keep all existing imports.

2. **Insert 3 new cards** after the Audit Logs card (after line 298, before the closing `</div>` of the quick actions grid on line 299). Follow the EXACT same card pattern used by the existing 6 cards:

Card 1 - Email Templates:
```tsx
<Card className="hover:shadow-md transition-shadow">
  <CardHeader>
    <CardTitle className="flex items-center gap-2">
      <Mail className="h-5 w-5 text-indigo-500" />
      Email Templates
    </CardTitle>
    <CardDescription>
      Customise email notification templates
    </CardDescription>
  </CardHeader>
  <CardContent>
    <Button asChild variant="outline" className="w-full">
      <Link href="/admin/email-templates">
        Manage Templates
        <ArrowRight className="ml-2 h-4 w-4" />
      </Link>
    </Button>
  </CardContent>
</Card>
```

Card 2 - API Documentation:
```tsx
<Card className="hover:shadow-md transition-shadow">
  <CardHeader>
    <CardTitle className="flex items-center gap-2">
      <Code className="h-5 w-5 text-teal-500" />
      API Documentation
    </CardTitle>
    <CardDescription>
      View API endpoints and integration docs
    </CardDescription>
  </CardHeader>
  <CardContent>
    <Button asChild variant="outline" className="w-full">
      <Link href="/admin/api-docs">
        View Docs
        <ArrowRight className="ml-2 h-4 w-4" />
      </Link>
    </Button>
  </CardContent>
</Card>
```

Card 3 - All Reports:
```tsx
<Card className="hover:shadow-md transition-shadow">
  <CardHeader>
    <CardTitle className="flex items-center gap-2">
      <FileText className="h-5 w-5 text-slate-500" />
      All Reports
    </CardTitle>
    <CardDescription>
      Search and filter all inspection reports
    </CardDescription>
  </CardHeader>
  <CardContent>
    <Button asChild variant="outline" className="w-full">
      <Link href="/admin/reports">
        Browse Reports
        <ArrowRight className="ml-2 h-4 w-4" />
      </Link>
    </Button>
  </CardContent>
</Card>
```

3. **Update grid breakpoints** on line 179: The grid currently uses `xl:grid-cols-6` for 6 cards. With 9 cards, change nothing -- the grid will naturally wrap. 6 columns at xl still works well (3 in first row, 3 in second, 3 in third at xl; fewer per row at smaller breakpoints). Keep `xl:grid-cols-6` as-is. Alternatively if desired, consider `xl:grid-cols-3` for a cleaner 3x3 grid, but the existing `xl:grid-cols-6` is fine since the cards will wrap naturally.

Do NOT modify any other part of the page (stats cards, recent activity, data fetching).
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Grep for `Mail` and `Code` in admin/page.tsx imports. Grep for `email-templates` and `api-docs` in the file -- both should appear in Link hrefs.</verify>
  <done>Admin dashboard has 9 quick action cards: 6 existing + Email Templates (linking to /admin/email-templates), API Documentation (linking to /admin/api-docs), and All Reports (linking to /admin/reports). Icons correctly imported from lucide-react.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor admin reports page with self-contained BatchPdfPanel</name>
  <files>src/app/(admin)/admin/reports/page.tsx, src/app/(admin)/admin/reports/admin-reports-content.tsx</files>
  <action>
**Approach:** Replace the current server-side data fetch + AdminReportsContent pattern with:
1. A simplified Server Component page that renders ReportSearch (handles all filtering, pagination, search)
2. A self-contained BatchPdfPanel that receives report IDs from the server AND displays a collapsible checklist so admin can select individual reports for batch PDF generation

**Step A: Refactor admin-reports-content.tsx to self-contained BatchPdfPanel**

Replace the entire file content. The new `BatchPdfPanel` component:
- Receives `reportIds` prop (string array) AND `reportLabels` prop (array of `{ id: string; reportNumber: string; address: string }`) so it can display a meaningful checklist
- Renders a collapsible Card with a disclosure toggle ("Show/Hide report list")
- When expanded, shows a scrollable checklist of reports with individual checkboxes per report (showing report number and address)
- Has "Select All" / "Deselect All" toggle at the top of the list
- Shows selected count and "Generate PDFs" button
- AlertDialog for confirmation before generation
- Calls POST `/api/admin/reports/batch-pdf` with selected IDs

This makes it FULLY SELF-CONTAINED -- no communication with ReportSearch needed. ReportSearch handles browsing/filtering. BatchPdfPanel handles selection and PDF generation independently.

Replace the full file content with:
```tsx
"use client";

import { useState, useCallback } from "react";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  CardDescription,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from "@/components/ui/collapsible";
import { Files, Loader2, ChevronDown, ChevronRight, MapPin } from "lucide-react";
import { useToast } from "@/hooks/use-toast";

interface ReportLabel {
  id: string;
  reportNumber: string;
  address: string;
}

interface BatchPdfPanelProps {
  reportLabels: ReportLabel[];
}

export function BatchPdfPanel({ reportLabels }: BatchPdfPanelProps) {
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [isGenerating, setIsGenerating] = useState(false);
  const [showConfirmDialog, setShowConfirmDialog] = useState(false);
  const [isOpen, setIsOpen] = useState(false);
  const { toast } = useToast();

  const allSelected =
    reportLabels.length > 0 && selectedIds.size === reportLabels.length;

  const toggleSelect = useCallback((id: string) => {
    setSelectedIds((prev) => {
      const next = new Set(prev);
      if (next.has(id)) {
        next.delete(id);
      } else {
        next.add(id);
      }
      return next;
    });
  }, []);

  const toggleSelectAll = useCallback(() => {
    if (allSelected) {
      setSelectedIds(new Set());
    } else {
      setSelectedIds(new Set(reportLabels.map((r) => r.id)));
    }
  }, [allSelected, reportLabels]);

  const handleGeneratePdfs = useCallback(async () => {
    setShowConfirmDialog(false);
    setIsGenerating(true);

    try {
      const response = await fetch("/api/admin/reports/batch-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ reportIds: Array.from(selectedIds) }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => null);
        throw new Error(errorData?.error || "Failed to generate PDFs");
      }

      const data = await response.json();

      if (data.failed > 0) {
        toast({
          title: "Batch PDF Generation",
          description: `Generated ${data.successful} PDFs successfully. ${data.failed} failed.`,
          variant: "info",
        });
      } else {
        toast({
          title: "Success",
          description: `Generated ${data.successful} PDFs successfully`,
          variant: "success",
        });
      }

      setSelectedIds(new Set());
    } catch (error) {
      toast({
        title: "Error",
        description:
          error instanceof Error ? error.message : "Failed to generate PDFs",
        variant: "destructive",
      });
    } finally {
      setIsGenerating(false);
    }
  }, [selectedIds, toast]);

  if (reportLabels.length === 0) return null;

  return (
    <>
      <Card>
        <Collapsible open={isOpen} onOpenChange={setIsOpen}>
          <CardHeader className="pb-3">
            <div className="flex items-center justify-between">
              <div>
                <CardTitle className="text-base">
                  Batch PDF Generation
                </CardTitle>
                <CardDescription>
                  Select reports and generate PDFs in bulk ({reportLabels.length}{" "}
                  reports available)
                </CardDescription>
              </div>
              <div className="flex items-center gap-2">
                {selectedIds.size > 0 && (
                  <Button
                    onClick={() => setShowConfirmDialog(true)}
                    disabled={isGenerating}
                    variant="outline"
                    size="sm"
                  >
                    {isGenerating ? (
                      <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    ) : (
                      <Files className="mr-2 h-4 w-4" />
                    )}
                    {isGenerating
                      ? "Generating..."
                      : `Generate PDFs (${selectedIds.size})`}
                  </Button>
                )}
                <CollapsibleTrigger asChild>
                  <Button variant="ghost" size="sm">
                    {isOpen ? (
                      <ChevronDown className="h-4 w-4" />
                    ) : (
                      <ChevronRight className="h-4 w-4" />
                    )}
                    <span className="ml-1 text-sm">
                      {isOpen ? "Hide" : "Select reports"}
                    </span>
                  </Button>
                </CollapsibleTrigger>
              </div>
            </div>
          </CardHeader>

          <CollapsibleContent>
            <CardContent className="pt-0">
              {/* Select all toggle */}
              <div className="flex items-center gap-2 pb-3 border-b mb-3">
                <Checkbox
                  checked={allSelected}
                  onCheckedChange={toggleSelectAll}
                  aria-label="Select all reports for PDF generation"
                />
                <span className="text-sm font-medium">
                  {allSelected
                    ? "Deselect all"
                    : `Select all ${reportLabels.length} reports`}
                </span>
                {selectedIds.size > 0 && !allSelected && (
                  <span className="text-sm text-muted-foreground">
                    ({selectedIds.size} selected)
                  </span>
                )}
              </div>

              {/* Scrollable report checklist */}
              <div className="max-h-64 overflow-y-auto space-y-1">
                {reportLabels.map((report) => (
                  <label
                    key={report.id}
                    className="flex items-center gap-3 py-1.5 px-2 rounded-md hover:bg-muted/50 cursor-pointer"
                  >
                    <Checkbox
                      checked={selectedIds.has(report.id)}
                      onCheckedChange={() => toggleSelect(report.id)}
                      aria-label={`Select report ${report.reportNumber}`}
                    />
                    <span className="text-sm font-medium">
                      {report.reportNumber}
                    </span>
                    <span className="text-sm text-muted-foreground flex items-center gap-1 truncate">
                      <MapPin className="h-3 w-3 shrink-0" />
                      {report.address}
                    </span>
                  </label>
                ))}
              </div>
            </CardContent>
          </CollapsibleContent>
        </Collapsible>
      </Card>

      <AlertDialog
        open={showConfirmDialog}
        onOpenChange={setShowConfirmDialog}
      >
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Generate PDFs</AlertDialogTitle>
            <AlertDialogDescription>
              Generate PDFs for {selectedIds.size} report
              {selectedIds.size !== 1 ? "s" : ""}? This may take a moment.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancel</AlertDialogCancel>
            <AlertDialogAction onClick={handleGeneratePdfs}>
              Generate
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}
```

**Key design notes:**
- The `Collapsible` component is from shadcn/ui -- check if it exists in the project. If not, run `npx shadcn@latest add collapsible` first.
- The panel is collapsed by default (no visual clutter on page load).
- Individual checkboxes per report with report number and address for identification.
- Max height of 16rem (256px) with overflow scroll so the list doesn't dominate the page.
- The "Generate PDFs" button appears in the header area when reports are selected, visible even when the list is collapsed.

**Step B: Refactor page.tsx**

Replace the current server-side data fetching with a simplified Server Component that:
1. Keeps auth check and admin role verification
2. Fetches report labels (id, reportNumber, address) for the batch PDF panel
3. Renders ReportSearch for full filtering/search/pagination
4. Renders BatchPdfPanel with the report labels

```tsx
import { auth } from "@clerk/nextjs/server";
import { redirect } from "next/navigation";
import prisma from "@/lib/db";
import { ReportSearch } from "@/components/reports/ReportSearch";
import { BatchPdfPanel } from "./admin-reports-content";

async function checkAdminAccess(userId: string) {
  const user = await prisma.user.findUnique({
    where: { clerkId: userId },
  });

  if (!user || !["REVIEWER", "ADMIN", "SUPER_ADMIN"].includes(user.role)) {
    return false;
  }

  return true;
}

async function getReportLabels() {
  const reports = await prisma.report.findMany({
    select: {
      id: true,
      reportNumber: true,
      propertyAddress: true,
      propertyCity: true,
    },
    orderBy: { createdAt: "desc" },
    take: 100,
  });
  return reports.map((r) => ({
    id: r.id,
    reportNumber: r.reportNumber,
    address: `${r.propertyAddress}${r.propertyCity ? `, ${r.propertyCity}` : ""}`,
  }));
}

export default async function AdminReportsPage() {
  const { userId } = await auth();

  if (!userId) {
    redirect("/sign-in");
  }

  const hasAccess = await checkAdminAccess(userId);

  if (!hasAccess) {
    redirect("/dashboard");
  }

  const reportLabels = await getReportLabels();

  return (
    <div className="space-y-8">
      <div>
        <h1 className="text-3xl font-bold tracking-tight">All Reports</h1>
        <p className="text-muted-foreground">
          Search, filter, and manage all inspection reports
        </p>
      </div>

      {/* Batch PDF generation panel (self-contained with own report checklist) */}
      <BatchPdfPanel reportLabels={reportLabels} />

      {/* Full search, filter, and report list */}
      <ReportSearch />
    </div>
  );
}
```

Note: ReportSearch is a `"use client"` component imported into a Server Component -- this is the correct Next.js 16 pattern (client components can be imported as children of server components).

**Pre-flight check:** Before implementing, verify the Collapsible component exists:
```bash
ls src/components/ui/collapsible.tsx 2>/dev/null || npx shadcn@latest add collapsible
```
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Grep for `ReportSearch` in admin/reports/page.tsx -- should appear. Grep for `BatchPdfPanel` in both files. Grep for `batch-pdf` in admin-reports-content.tsx -- should still be present (the API call). Grep for `toggleSelect` in admin-reports-content.tsx -- should appear (individual report selection). Grep for `Collapsible` in admin-reports-content.tsx -- should appear (collapsible panel).</verify>
  <done>Admin reports page renders ReportSearch component providing full filtering (severity, compliance, inspector, date range, text search, sort, pagination). Batch PDF generation preserved via self-contained BatchPdfPanel with collapsible report checklist showing report numbers and addresses, individual checkbox selection per report, select all/deselect all toggle, and Generate PDFs button. No cross-component state needed -- BatchPdfPanel is fully independent. Server Component correctly imports client components. Auth/role check retained.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero type errors across the project
2. Admin dashboard page.tsx contains 9 Card components in the quick actions grid
3. Admin dashboard links to `/admin/email-templates`, `/admin/api-docs`, `/admin/reports`
4. Admin reports page.tsx imports and renders ReportSearch
5. Admin reports page.tsx imports and renders BatchPdfPanel with reportLabels (not just IDs)
6. admin-reports-content.tsx exports BatchPdfPanel with collapsible report checklist
7. BatchPdfPanel has individual checkboxes per report (toggleSelect function exists)
8. BatchPdfPanel has select all/deselect all toggle (toggleSelectAll function exists)
9. Batch PDF API call to `/api/admin/reports/batch-pdf` still present
10. Collapsible component from shadcn/ui is installed and imported
</verification>

<success_criteria>
- Admin dashboard shows 9 quick action cards including Email Templates, API Documentation, and All Reports
- Email Templates card links to /admin/email-templates with Mail icon
- API Documentation card links to /admin/api-docs with Code icon
- All Reports card links to /admin/reports with FileText icon
- Admin reports page uses ReportSearch for filtering by severity, compliance status, inspector, date range, and more
- Admin can expand the Batch PDF panel to see a checklist of reports with report numbers and addresses
- Admin can select individual reports via checkboxes in the checklist
- Admin can select/deselect all reports with a single toggle
- Selected count is displayed and Generate PDFs button appears when reports are selected
- BatchPdfPanel is fully self-contained -- does not depend on ReportSearch state
- All TypeScript compiles cleanly
- Server Component / Client Component boundary is correct (no hydration issues)
</success_criteria>

<output>
After completion, create `.planning/phases/10-admin-polish-email-wireup/10-02-SUMMARY.md`
</output>
