---
phase: 10-admin-polish-email-wireup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(admin)/admin/page.tsx
  - src/app/(admin)/admin/reports/page.tsx
  - src/app/(admin)/admin/reports/admin-reports-content.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Admin dashboard shows quick action cards for Email Templates, API Docs, and All Reports"
    - "Admin reports page supports filtering by severity, compliance status, inspector, and date range"
    - "Admin reports page retains batch PDF generation capability"
  artifacts:
    - path: "src/app/(admin)/admin/page.tsx"
      provides: "9 quick action cards (6 existing + 3 new)"
      contains: "email-templates"
    - path: "src/app/(admin)/admin/reports/page.tsx"
      provides: "Admin reports page with ReportSearch and batch PDF panel"
      contains: "ReportSearch"
    - path: "src/app/(admin)/admin/reports/admin-reports-content.tsx"
      provides: "Batch PDF action panel (stripped of report list display)"
      contains: "handleGeneratePdfs"
  key_links:
    - from: "src/app/(admin)/admin/page.tsx"
      to: "/admin/email-templates"
      via: "Link href"
      pattern: "href.*admin/email-templates"
    - from: "src/app/(admin)/admin/page.tsx"
      to: "/admin/api-docs"
      via: "Link href"
      pattern: "href.*admin/api-docs"
    - from: "src/app/(admin)/admin/reports/page.tsx"
      to: "src/components/reports/ReportSearch.tsx"
      via: "component import"
      pattern: "import.*ReportSearch"
---

<objective>
Add 3 missing quick action cards to the admin dashboard and replace the admin reports page with the full-featured ReportSearch component while preserving batch PDF generation.

Purpose: Admin dashboard is missing navigation links to Email Templates, API Docs, and All Reports. Admin reports page lacks the filtering capabilities that ReportSearch already provides (severity, compliance, inspector, date range).

Output: Admin dashboard with 9 quick action cards. Admin reports page using ReportSearch for full filtering + a batch PDF action panel preserved from admin-reports-content.tsx.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-admin-polish-email-wireup/10-RESEARCH.md

Key source files:
@src/app/(admin)/admin/page.tsx
@src/app/(admin)/admin/reports/page.tsx
@src/app/(admin)/admin/reports/admin-reports-content.tsx
@src/components/reports/ReportSearch.tsx (first 50 lines for import reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 3 quick action cards to admin dashboard</name>
  <files>src/app/(admin)/admin/page.tsx</files>
  <action>
Modify `src/app/(admin)/admin/page.tsx`:

1. **Update lucide-react imports** (line 8-19): Add `Mail` and `Code` to the import list. `FileText` is already imported. Keep all existing imports.

2. **Insert 3 new cards** after the Audit Logs card (after line 298, before the closing `</div>` of the quick actions grid on line 299). Follow the EXACT same card pattern used by the existing 6 cards:

Card 1 - Email Templates:
```tsx
<Card className="hover:shadow-md transition-shadow">
  <CardHeader>
    <CardTitle className="flex items-center gap-2">
      <Mail className="h-5 w-5 text-indigo-500" />
      Email Templates
    </CardTitle>
    <CardDescription>
      Customise email notification templates
    </CardDescription>
  </CardHeader>
  <CardContent>
    <Button asChild variant="outline" className="w-full">
      <Link href="/admin/email-templates">
        Manage Templates
        <ArrowRight className="ml-2 h-4 w-4" />
      </Link>
    </Button>
  </CardContent>
</Card>
```

Card 2 - API Documentation:
```tsx
<Card className="hover:shadow-md transition-shadow">
  <CardHeader>
    <CardTitle className="flex items-center gap-2">
      <Code className="h-5 w-5 text-teal-500" />
      API Documentation
    </CardTitle>
    <CardDescription>
      View API endpoints and integration docs
    </CardDescription>
  </CardHeader>
  <CardContent>
    <Button asChild variant="outline" className="w-full">
      <Link href="/admin/api-docs">
        View Docs
        <ArrowRight className="ml-2 h-4 w-4" />
      </Link>
    </Button>
  </CardContent>
</Card>
```

Card 3 - All Reports:
```tsx
<Card className="hover:shadow-md transition-shadow">
  <CardHeader>
    <CardTitle className="flex items-center gap-2">
      <FileText className="h-5 w-5 text-slate-500" />
      All Reports
    </CardTitle>
    <CardDescription>
      Search and filter all inspection reports
    </CardDescription>
  </CardHeader>
  <CardContent>
    <Button asChild variant="outline" className="w-full">
      <Link href="/admin/reports">
        Browse Reports
        <ArrowRight className="ml-2 h-4 w-4" />
      </Link>
    </Button>
  </CardContent>
</Card>
```

3. **Update grid breakpoints** on line 179: The grid currently uses `xl:grid-cols-6` for 6 cards. With 9 cards, change nothing -- the grid will naturally wrap. 6 columns at xl still works well (3 in first row, 3 in second, 3 in third at xl; fewer per row at smaller breakpoints). Keep `xl:grid-cols-6` as-is. Alternatively if desired, consider `xl:grid-cols-3` for a cleaner 3x3 grid, but the existing `xl:grid-cols-6` is fine since the cards will wrap naturally.

Do NOT modify any other part of the page (stats cards, recent activity, data fetching).
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Grep for `Mail` and `Code` in admin/page.tsx imports. Grep for `email-templates` and `api-docs` in the file -- both should appear in Link hrefs.</verify>
  <done>Admin dashboard has 9 quick action cards: 6 existing + Email Templates (linking to /admin/email-templates), API Documentation (linking to /admin/api-docs), and All Reports (linking to /admin/reports). Icons correctly imported from lucide-react.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor admin reports page to use ReportSearch with batch PDF</name>
  <files>src/app/(admin)/admin/reports/page.tsx, src/app/(admin)/admin/reports/admin-reports-content.tsx</files>
  <action>
**Approach:** Replace the current server-side data fetch + AdminReportsContent pattern with:
1. A simplified Server Component page that renders ReportSearch (handles all filtering, pagination, search)
2. A slimmed-down AdminReportsContent that ONLY provides the batch PDF generation panel (select reports + generate button)

**Step A: Refactor admin-reports-content.tsx to batch PDF panel only**

Rename the export to `BatchPdfPanel`. Strip out the report list display and keep only:
- State: `selectedIds`, `isGenerating`, `showConfirmDialog`
- The `handleGeneratePdfs` function (lines 115-158)
- The batch action bar (checkbox select all, "Generate PDFs" button) (lines 186-232)
- The AlertDialog for confirmation (lines 235-251)

The component needs a `reportIds` prop (string array) so it knows which reports are available for selection. It will NOT display reports -- that is ReportSearch's job. Instead, render a collapsible panel with:
- A summary: "Select reports for batch PDF generation"
- A "Select All" checkbox
- A count of selected reports
- The "Generate PDFs" button

Replace the full file content with:
```tsx
"use client";

import { useState, useCallback } from "react";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { Files, Loader2 } from "lucide-react";
import { useToast } from "@/hooks/use-toast";

interface BatchPdfPanelProps {
  reportIds: string[];
}

export function BatchPdfPanel({ reportIds }: BatchPdfPanelProps) {
  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
  const [isGenerating, setIsGenerating] = useState(false);
  const [showConfirmDialog, setShowConfirmDialog] = useState(false);
  const { toast } = useToast();

  const allSelected = reportIds.length > 0 && selectedIds.size === reportIds.length;

  const toggleSelectAll = useCallback(() => {
    if (allSelected) {
      setSelectedIds(new Set());
    } else {
      setSelectedIds(new Set(reportIds));
    }
  }, [allSelected, reportIds]);

  const handleGeneratePdfs = useCallback(async () => {
    setShowConfirmDialog(false);
    setIsGenerating(true);

    try {
      const response = await fetch("/api/admin/reports/batch-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ reportIds: Array.from(selectedIds) }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => null);
        throw new Error(errorData?.error || "Failed to generate PDFs");
      }

      const data = await response.json();

      if (data.failed > 0) {
        toast({
          title: "Batch PDF Generation",
          description: `Generated ${data.successful} PDFs successfully. ${data.failed} failed.`,
          variant: "info",
        });
      } else {
        toast({
          title: "Success",
          description: `Generated ${data.successful} PDFs successfully`,
          variant: "success",
        });
      }

      setSelectedIds(new Set());
    } catch (error) {
      toast({
        title: "Error",
        description:
          error instanceof Error ? error.message : "Failed to generate PDFs",
        variant: "destructive",
      });
    } finally {
      setIsGenerating(false);
    }
  }, [selectedIds, toast]);

  if (reportIds.length === 0) return null;

  return (
    <>
      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-base">Batch PDF Generation</CardTitle>
          <CardDescription>
            Select reports and generate PDFs in bulk
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2">
              <Checkbox
                checked={allSelected}
                onCheckedChange={toggleSelectAll}
                aria-label="Select all reports for PDF generation"
              />
              <span className="text-sm text-muted-foreground">
                {selectedIds.size > 0
                  ? `${selectedIds.size} of ${reportIds.length} selected`
                  : `Select all ${reportIds.length} reports`}
              </span>
            </div>

            {selectedIds.size > 0 && (
              <Button
                onClick={() => setShowConfirmDialog(true)}
                disabled={isGenerating}
                variant="outline"
                size="sm"
              >
                {isGenerating ? (
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                ) : (
                  <Files className="mr-2 h-4 w-4" />
                )}
                {isGenerating
                  ? "Generating..."
                  : `Generate PDFs (${selectedIds.size})`}
              </Button>
            )}
          </div>
        </CardContent>
      </Card>

      <AlertDialog open={showConfirmDialog} onOpenChange={setShowConfirmDialog}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Generate PDFs</AlertDialogTitle>
            <AlertDialogDescription>
              Generate PDFs for {selectedIds.size} report
              {selectedIds.size !== 1 ? "s" : ""}? This may take a moment.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancel</AlertDialogCancel>
            <AlertDialogAction onClick={handleGeneratePdfs}>
              Generate
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}
```

**Step B: Refactor page.tsx**

Replace the current server-side data fetching with a simplified Server Component that:
1. Keeps auth check and admin role verification
2. Fetches just the report IDs for the batch PDF panel (lightweight query)
3. Renders ReportSearch for full filtering/search/pagination
4. Renders BatchPdfPanel with the report IDs

```tsx
import { auth } from "@clerk/nextjs/server";
import { redirect } from "next/navigation";
import prisma from "@/lib/db";
import { ReportSearch } from "@/components/reports/ReportSearch";
import { BatchPdfPanel } from "./admin-reports-content";

async function checkAdminAccess(userId: string) {
  const user = await prisma.user.findUnique({
    where: { clerkId: userId },
  });

  if (!user || !["REVIEWER", "ADMIN", "SUPER_ADMIN"].includes(user.role)) {
    return false;
  }

  return true;
}

async function getReportIds() {
  const reports = await prisma.report.findMany({
    select: { id: true },
    orderBy: { createdAt: "desc" },
    take: 100,
  });
  return reports.map((r) => r.id);
}

export default async function AdminReportsPage() {
  const { userId } = await auth();

  if (!userId) {
    redirect("/sign-in");
  }

  const hasAccess = await checkAdminAccess(userId);

  if (!hasAccess) {
    redirect("/dashboard");
  }

  const reportIds = await getReportIds();

  return (
    <div className="space-y-8">
      <div>
        <h1 className="text-3xl font-bold tracking-tight">All Reports</h1>
        <p className="text-muted-foreground">
          Search, filter, and manage all inspection reports
        </p>
      </div>

      {/* Batch PDF generation panel */}
      <BatchPdfPanel reportIds={reportIds} />

      {/* Full search, filter, and report list */}
      <ReportSearch />
    </div>
  );
}
```

Note: ReportSearch is a `"use client"` component imported into a Server Component -- this is the correct Next.js 16 pattern (client components can be imported as children of server components).
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Grep for `ReportSearch` in admin/reports/page.tsx -- should appear. Grep for `BatchPdfPanel` in both files. Grep for `batch-pdf` in admin-reports-content.tsx -- should still be present (the API call).</verify>
  <done>Admin reports page renders ReportSearch component providing full filtering (severity, compliance, inspector, date range, text search, sort, pagination). Batch PDF generation preserved via BatchPdfPanel component. Server Component correctly imports client components. Auth/role check retained.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero type errors across the project
2. Admin dashboard page.tsx contains 9 Card components in the quick actions grid
3. Admin dashboard links to `/admin/email-templates`, `/admin/api-docs`, `/admin/reports`
4. Admin reports page.tsx imports and renders ReportSearch
5. Admin reports page.tsx imports and renders BatchPdfPanel with report IDs
6. admin-reports-content.tsx exports BatchPdfPanel (not the old AdminReportsContent)
7. Batch PDF API call to `/api/admin/reports/batch-pdf` still present
</verification>

<success_criteria>
- Admin dashboard shows 9 quick action cards including Email Templates, API Documentation, and All Reports
- Email Templates card links to /admin/email-templates with Mail icon
- API Documentation card links to /admin/api-docs with Code icon
- All Reports card links to /admin/reports with FileText icon
- Admin reports page uses ReportSearch for filtering by severity, compliance status, inspector, date range, and more
- Admin reports page retains batch PDF generation via BatchPdfPanel
- All TypeScript compiles cleanly
- Server Component / Client Component boundary is correct (no hydration issues)
</success_criteria>

<output>
After completion, create `.planning/phases/10-admin-polish-email-wireup/10-02-SUMMARY.md`
</output>
