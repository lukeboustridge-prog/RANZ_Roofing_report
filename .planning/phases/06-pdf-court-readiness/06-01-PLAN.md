---
phase: 06-pdf-court-readiness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/reports/[id]/edit/page.tsx
  - src/lib/validations/report.ts
autonomous: true

must_haves:
  truths:
    - "Inspector can enter methodology text describing inspection approach in the report edit form"
    - "Inspector can enter equipment list (comma-separated or multi-line) in the report edit form"
    - "Methodology and equipment data persists after save and page reload"
  artifacts:
    - path: "src/app/(dashboard)/reports/[id]/edit/page.tsx"
      provides: "Methodology textarea and equipment textarea fields in Inspection Details card"
      contains: "methodology"
    - path: "src/lib/validations/report.ts"
      provides: "Equipment field in UpdateReportSchema"
      contains: "equipment"
  key_links:
    - from: "src/app/(dashboard)/reports/[id]/edit/page.tsx"
      to: "/api/reports/[id]"
      via: "PATCH request with methodology and equipment in body"
      pattern: "methodology|equipment"
    - from: "src/lib/validations/report.ts"
      to: "prisma.report.update"
      via: "Zod validation in PATCH handler"
      pattern: "equipment.*optional"
---

<objective>
Add methodology and equipment form fields to the report edit page so inspectors can enter this data, and update the validation schema to accept equipment in API requests.

Purpose: Without data entry fields, the methodology and equipment PDF sections will always render empty. This is the prerequisite for all PDF-01 and PDF-02 requirements.

Output: Updated edit page with two new form fields (methodology textarea, equipment textarea), updated validation schema with equipment field, both fields saving via existing autosave/PATCH flow.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key files to read before implementing:
@src/app/(dashboard)/reports/[id]/edit/page.tsx
@src/lib/validations/report.ts
@src/app/api/reports/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add equipment to validation schema and add methodology + equipment form fields</name>
  <files>
    src/lib/validations/report.ts
    src/app/(dashboard)/reports/[id]/edit/page.tsx
  </files>
  <action>
**Step 1: Update validation schema** (`src/lib/validations/report.ts`)

In the `UpdateReportSchema` (line ~84), add an `equipment` field alongside the existing `methodology` field:

```typescript
equipment: z.union([z.array(z.string()), z.unknown()]).optional().nullable(),
```

This allows the API to accept equipment as either a string array (from our form) or unknown JSON (backward-compatible with existing data). Place it right after the `methodology` line.

**Step 2: Update FormData interface** (`src/app/(dashboard)/reports/[id]/edit/page.tsx`)

Add two new fields to the `FormData` interface (around line 61-77):
```typescript
methodology: string;
equipment: string;
```

**Step 3: Update fetchReport data mapping** (around line 128-146)

In the `fetchReport` function where `setFormData` is called, add:
```typescript
methodology: typeof data.methodology === 'string' ? data.methodology : (data.methodology ? JSON.stringify(data.methodology) : ""),
equipment: Array.isArray(data.equipment) ? data.equipment.join(", ") : (typeof data.equipment === 'string' ? data.equipment : ""),
```

The methodology field in the DB is Json?, so it might be stored as a string or object. Coerce to string for the textarea. Equipment is Json? stored as a string array, so join with commas for display.

**Step 4: Update handleSubmit body** (around line 170-178)

In the submit handler where the PATCH body is built, transform the form values back to DB format:
```typescript
methodology: formData.methodology || null,
equipment: formData.equipment ? formData.equipment.split(/[,\n]/).map(s => s.trim()).filter(Boolean) : null,
```

Also update the `handleAutosave` function (around line 88-107) to include the same transformation in its JSON.stringify body. The autosave sends the full formData, so add a transform:
```typescript
body: JSON.stringify({
  ...data,
  buildingAge: data.buildingAge ? parseInt(data.buildingAge) : null,
  methodology: data.methodology || null,
  equipment: data.equipment ? data.equipment.split(/[,\n]/).map((s: string) => s.trim()).filter(Boolean) : null,
}),
```

**Step 5: Add form fields to the Inspection Details card**

In the JSX, inside the "Inspection Details" Card (after the existing "Weather Conditions" input at ~line 418, BEFORE the "Access Method" input at ~line 420), add:

1. A **Methodology** textarea field:
```tsx
<div>
  <Label htmlFor="methodology">Inspection Methodology</Label>
  <Textarea
    id="methodology"
    value={formData.methodology}
    onChange={(e) => updateField("methodology", e.target.value)}
    disabled={isFinalised}
    placeholder="Describe the inspection approach, process, and standards followed..."
    rows={4}
  />
  <p className="text-xs text-muted-foreground mt-1">
    ISO 17020 required. Describe the inspection process and standards referenced.
  </p>
</div>
```

2. An **Equipment** textarea field:
```tsx
<div>
  <Label htmlFor="equipment">Equipment Used</Label>
  <Textarea
    id="equipment"
    value={formData.equipment}
    onChange={(e) => updateField("equipment", e.target.value)}
    disabled={isFinalised}
    placeholder="List instruments used, separated by commas or new lines (e.g., moisture meter, drone, thermal camera...)"
    rows={3}
  />
  <p className="text-xs text-muted-foreground mt-1">
    ISO 17020 required. List all instruments and tools used during inspection.
  </p>
</div>
```

Place these two fields in this order: Weather Conditions, Methodology, Equipment, Access Method, Limitations. This groups the ISO 17020 required fields logically.

**Important notes:**
- Do NOT change the existing accessMethod or limitations fields -- they already work.
- The `Textarea` component is already imported at line 10.
- The `updateField` function already handles any key of FormData, so no changes needed there.
- The autosave hook (`useAutosave`) watches `formData` changes, so new fields will autosave automatically as long as the handleAutosave body includes them.
  </action>
  <verify>
1. Run `npx tsc --noEmit` from the project root -- no type errors
2. Run `npm run build` or `npx next build` -- build succeeds (the edit page compiles)
3. Visually confirm the form fields appear by searching the compiled output for "Inspection Methodology" and "Equipment Used" strings
  </verify>
  <done>
- FormData interface includes methodology and equipment string fields
- UpdateReportSchema includes equipment validation
- Edit page renders Methodology textarea and Equipment textarea between Weather Conditions and Access Method
- Data is transformed correctly: methodology saves as string, equipment saves as string[] array
- Autosave includes both new fields in its PATCH payload
  </done>
</task>

<task type="auto">
  <name>Task 2: Update end-user documentation for new form fields</name>
  <files>
    docs/inspector-guide.md
  </files>
  <action>
Read `docs/inspector-guide.md` and find the section describing the report edit form or inspection details step. Add documentation for the two new fields:

1. **Inspection Methodology** -- Explain this is an ISO 17020 required field. Inspectors should describe their inspection approach, the process followed, and which standards were referenced. Example: "Visual inspection of all accessible roof areas conducted in accordance with RANZ Roofing Inspection Methodology 2025 and ISO/IEC 17020:2012. Non-invasive assessment with drone supplement for inaccessible areas."

2. **Equipment Used** -- Explain this is an ISO 17020 required field. List all instruments and tools used, separated by commas. Example: "Moisture meter (Tramex MRH III), DJI Mini 3 Pro drone, 6m extension ladder, digital camera (Canon EOS R6), measuring tape, spirit level"

Keep the documentation style consistent with the existing guide. If the guide uses specific formatting patterns (headers, bullet points, callouts), match them.

If `docs/inspector-guide.md` does not contain a section about the edit form, add a subsection under the most relevant existing section (likely "Creating a Report" or "Editing a Report").
  </action>
  <verify>
Read the updated docs/inspector-guide.md and confirm methodology and equipment fields are documented with examples.
  </verify>
  <done>
- Inspector guide documents the Methodology and Equipment fields with clear descriptions and examples
- Documentation style matches the existing guide format
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Next.js build succeeds: `npm run build`
3. Form has Methodology and Equipment textareas in the Inspection Details card
4. Validation schema accepts equipment field in PATCH requests
5. Inspector guide updated with new field documentation
</verification>

<success_criteria>
- Edit page has Methodology textarea between Weather Conditions and Access Method
- Edit page has Equipment textarea between Methodology and Access Method
- Both fields are labeled with "ISO 17020 required" helper text
- Methodology saves as string via PATCH /api/reports/[id]
- Equipment saves as string[] array via PATCH /api/reports/[id] (split on comma/newline)
- Both fields participate in autosave
- TypeScript compiles without errors
- Inspector documentation updated
</success_criteria>

<output>
After completion, create `.planning/phases/06-pdf-court-readiness/06-01-SUMMARY.md`
</output>
