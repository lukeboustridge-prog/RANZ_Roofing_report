---
phase: 08-search-filtering-templates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/reports/TemplateSelector.tsx
  - src/app/(dashboard)/reports/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can select a saved template during report creation and have its fields pre-populated"
    - "Template selection is optional -- user can skip and create report without a template"
    - "Selected template pre-fills inspectionType in the wizard form"
    - "After report creation, the template apply endpoint is called to fill scopeOfWorks, methodology, and equipment"
  artifacts:
    - path: "src/components/reports/TemplateSelector.tsx"
      provides: "Template picker component showing available templates as cards"
      min_lines: 40
    - path: "src/app/(dashboard)/reports/new/page.tsx"
      provides: "4-step wizard with optional Template step before Property"
      contains: "TemplateSelector|selectedTemplate|template"
  key_links:
    - from: "src/components/reports/TemplateSelector.tsx"
      to: "/api/templates"
      via: "fetch in useEffect"
      pattern: "fetch.*api/templates"
    - from: "src/app/(dashboard)/reports/new/page.tsx"
      to: "/api/templates/[id]/apply"
      via: "fetch POST after report creation"
      pattern: "fetch.*api/templates.*apply"
---

<objective>
Add an optional template selection step to the report creation wizard so users can pre-populate report fields from a saved template.

Purpose: Inspectors frequently create similar types of reports (e.g., full inspections, dispute reports). Templates already exist with full CRUD and an apply endpoint, but the creation wizard has no way to select one. This plan wires the template system into the wizard as an optional first step, saving inspectors time and ensuring consistency.

Output: A new TemplateSelector component and an updated 4-step report creation wizard (Template > Property > Inspection > Client) where step 1 is skippable.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-search-filtering-templates/08-RESEARCH.md
@src/app/(dashboard)/reports/new/page.tsx
@src/app/api/templates/route.ts
@src/app/api/templates/[id]/apply/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TemplateSelector component</name>
  <files>src/components/reports/TemplateSelector.tsx</files>
  <action>
  Create a new client component at `src/components/reports/TemplateSelector.tsx` that fetches and displays available templates for selection.

  The component should:

  1. **Props interface:**
     ```typescript
     interface Template {
       id: string;
       name: string;
       description: string | null;
       inspectionType: string;
       isDefault: boolean;
     }

     interface TemplateSelectorProps {
       selectedTemplateId: string | null;
       onSelect: (templateId: string | null, inspectionType?: string) => void;
     }
     ```

  2. **Fetch templates** on mount from `GET /api/templates` (which already returns active templates). Filter to only `isActive: true` templates (the API already does this by default).

  3. **Display templates as selectable cards** using existing shadcn/ui Card component:
     - Each card shows: template name, description (truncated), inspection type badge
     - Selected card has a highlighted border (use `ring-2 ring-[var(--ranz-blue-500)]`)
     - Include a "No template" option that deselects any template
     - Default templates should show a small "Default" badge

  4. **On selection**, call `onSelect(templateId, template.inspectionType)` so the parent can pre-fill the inspectionType field.

  5. **Loading state**: Show skeleton cards while loading using `Loader2` spinner.

  6. **Empty state**: If no templates exist, show a message: "No templates available. You can create templates in the admin panel."

  7. **Error handling**: If fetch fails, show error message but allow proceeding without template.

  Use these imports from existing UI library:
  - `Card, CardContent, CardHeader, CardTitle, CardDescription` from `@/components/ui/card`
  - `Badge` from `@/components/ui/badge`
  - `Button` from `@/components/ui/button`
  - `Loader2, Check, FileText` from `lucide-react`

  Use the existing `inspectionTypeLabels` pattern for displaying inspection type names -- define a local map or import from a shared location. Since the labels are already defined in `ReportSearch.tsx`, duplicate them locally in this component (the inspection type enum is small and stable).

  Mark as `"use client"` since it uses useState/useEffect.
  </action>
  <verify>
  Run `npx tsc --noEmit` to confirm the component compiles without type errors.
  </verify>
  <done>
  TemplateSelector component exists at src/components/reports/TemplateSelector.tsx, fetches templates from /api/templates, renders them as selectable cards, and calls onSelect callback with template ID and inspectionType when user picks one.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate template selection into the report creation wizard</name>
  <files>src/app/(dashboard)/reports/new/page.tsx</files>
  <action>
  Modify the existing 3-step report creation wizard to include an optional template selection step as step 1, shifting existing steps to 2, 3, 4.

  1. **Import TemplateSelector:**
     ```typescript
     import { TemplateSelector } from "@/components/reports/TemplateSelector";
     ```

  2. **Add template state** alongside existing state:
     ```typescript
     const [selectedTemplateId, setSelectedTemplateId] = useState<string | null>(null);
     ```

  3. **Change step count from 3 to 4.** Update the step state initial value to 1 (keep it at 1).

  4. **Update the progress indicator** to show 4 steps instead of 3:
     - Step 1: "Template" (optional)
     - Step 2: "Property"
     - Step 3: "Inspection"
     - Step 4: "Client"

     Update the map from `[1, 2, 3]` to `[1, 2, 3, 4]` and the label logic:
     ```typescript
     {s === 1 ? "Template" : s === 2 ? "Property" : s === 3 ? "Inspection" : "Client"}
     ```
     Update the connector line condition from `s < 3` to `s < 4`.

  5. **Add Step 1: Template Selection** (renders when `step === 1`):
     ```tsx
     {step === 1 && (
       <Card>
         <CardHeader>
           <CardTitle>Select Template (Optional)</CardTitle>
           <CardDescription>
             Choose a template to pre-fill your report with standard content, or skip this step to start from scratch.
           </CardDescription>
         </CardHeader>
         <CardContent>
           <TemplateSelector
             selectedTemplateId={selectedTemplateId}
             onSelect={(templateId, inspectionType) => {
               setSelectedTemplateId(templateId);
               if (inspectionType) {
                 updateField("inspectionType", inspectionType);
               }
             }}
           />
         </CardContent>
       </Card>
     )}
     ```

  6. **Shift existing step conditionals:**
     - `step === 1` (Property) becomes `step === 2`
     - `step === 2` (Inspection) becomes `step === 3`
     - `step === 3` (Client) becomes `step === 4`

  7. **Update canProceed():**
     ```typescript
     const canProceed = () => {
       if (step === 1) return true; // Template step is always optional
       if (step === 2) {
         return (
           formData.propertyAddress &&
           formData.propertyCity &&
           formData.propertyRegion &&
           formData.propertyPostcode &&
           formData.propertyType
         );
       }
       if (step === 3) {
         return formData.inspectionDate && formData.inspectionType;
       }
       if (step === 4) {
         return formData.clientName;
       }
       return true;
     };
     ```

  8. **Update navigation buttons:**
     - Back button: disabled when `step === 1`
     - Next/Submit: show "Next" for steps 1-3, show "Create Report" for step 4
     - Change `step < 3` to `step < 4` for the Next vs Submit conditional

  9. **Update handleSubmit** to apply template after report creation:
     ```typescript
     const handleSubmit = async () => {
       setLoading(true);
       setError("");

       try {
         const response = await fetch("/api/reports", {
           method: "POST",
           headers: { "Content-Type": "application/json" },
           body: JSON.stringify({
             ...formData,
             buildingAge: formData.buildingAge ? parseInt(formData.buildingAge) : null,
             inspectionDate: new Date(formData.inspectionDate).toISOString(),
           }),
         });

         const contentType = response.headers.get("content-type");
         if (!contentType || !contentType.includes("application/json")) {
           if (!response.ok) {
             throw new Error(`Server error: ${response.status} ${response.statusText}`);
           }
           throw new Error("Invalid response from server");
         }

         const data = await response.json();

         if (!response.ok) {
           throw new Error(data.error || "Failed to create report");
         }

         // Apply template if one was selected (TMPL-01)
         if (selectedTemplateId) {
           try {
             await fetch(`/api/templates/${selectedTemplateId}/apply`, {
               method: "POST",
               headers: { "Content-Type": "application/json" },
               body: JSON.stringify({ reportId: data.id }),
             });
           } catch {
             // Template application is non-critical -- report was created successfully
             // User can manually apply template later from report editor
             console.warn("Template application failed, continuing to report editor");
           }
         }

         router.push(`/reports/${data.id}`);
       } catch (err) {
         setError(err instanceof Error ? err.message : "An error occurred");
       } finally {
         setLoading(false);
       }
     };
     ```

  **Important notes:**
  - Template selection is fire-and-forget with .catch() -- consistent with project pattern for non-critical operations (see decision in STATE.md about notifications being fire-and-forget).
  - The template apply endpoint already validates that the report is in DRAFT status and belongs to the user, and creates an audit log entry.
  - Keep existing form validation, error handling, and styling patterns intact.
  - The "Skip" functionality is implicit -- step 1 always passes canProceed(), and the user simply clicks "Next" without selecting a template.
  </action>
  <verify>
  Run `npx tsc --noEmit` to confirm no type errors. Run `npm run build` to confirm the page builds successfully.
  </verify>
  <done>
  The report creation wizard at /reports/new shows 4 steps: Template (optional) > Property > Inspection > Client. When a template is selected, the inspectionType field is pre-filled in the form. On submit, the template apply endpoint is called after report creation to fill scopeOfWorks, methodology, and equipment. Users can skip the template step entirely.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no new type errors
2. `npm run build` succeeds
3. /reports/new page shows 4-step progress indicator (Template, Property, Inspection, Client)
4. Step 1 displays available templates as selectable cards
5. Selecting a template pre-fills the inspectionType on Step 3
6. Clicking "Next" without selecting a template proceeds normally (skip behavior)
7. After submission with a template selected, POST to /api/templates/[id]/apply is called
8. Report is created and user is redirected to the report editor regardless of template apply success
</verification>

<success_criteria>
- TMPL-01 requirement is satisfied: user can select and apply a saved template when creating a new report
- Template selection is optional and does not block report creation
- TypeScript compiles without errors
- Existing wizard functionality (property/inspection/client steps) unchanged
- Template application creates audit log entry via the existing apply endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/08-search-filtering-templates/08-02-SUMMARY.md`
</output>
