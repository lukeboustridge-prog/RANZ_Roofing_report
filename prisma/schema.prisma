generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id      String     @id @default(cuid())
  clerkId String     @unique
  email   String     @unique
  name    String
  phone   String?
  role    UserRole   @default(INSPECTOR)
  status  UserStatus @default(ACTIVE)

  // Business details
  company String?
  address String? @db.Text

  // Inspector credentials
  qualifications  String?  @db.Text
  lbpNumber       String?
  yearsExperience Int?
  specialisations String[]
  cvUrl           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reports        Report[]
  assignments    Assignment[]
  reviewComments ReviewComment[] @relation("ReviewComments")
  preferences    UserPreferences?
}

enum UserRole {
  INSPECTOR
  REVIEWER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  PENDING_APPROVAL
}

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email notification preferences
  emailReportSubmitted   Boolean @default(true)  // When a report is submitted for review
  emailReportApproved    Boolean @default(true)  // When a report is approved
  emailReportRejected    Boolean @default(true)  // When a report needs revision
  emailReportComments    Boolean @default(true)  // When new comments are added
  emailReportFinalized   Boolean @default(true)  // When a report is finalized
  emailAssignmentNew     Boolean @default(true)  // When assigned to a new inspection
  emailWeeklyDigest      Boolean @default(false) // Weekly summary email

  // UI preferences
  theme           String @default("system") // system, light, dark
  defaultListView String @default("grid")   // grid, list
  itemsPerPage    Int    @default(12)

  // Default report settings
  defaultInspectionType String? // Pre-fill inspection type
  defaultRegion         String? // Pre-fill region

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============================================
// INSPECTION REPORTS
// ============================================

model Report {
  id           String       @id @default(cuid())
  reportNumber String       @unique // RANZ-2025-001234
  status       ReportStatus @default(DRAFT)

  // Property Details
  propertyAddress  String
  propertyCity     String
  propertyRegion   String
  propertyPostcode String
  propertyType     PropertyType
  buildingAge      Int?
  gpsLat           Float?
  gpsLng           Float?

  // Inspection Details
  inspectionDate    DateTime
  inspectionType    InspectionType
  weatherConditions String?
  temperature       Float?
  accessMethod      String?
  limitations       String?        @db.Text

  // Client Information
  clientName    String
  clientEmail   String?
  clientPhone   String?
  clientCompany String?
  engagingParty String?

  // Building Consent
  consentNumber        String?
  consentDate          DateTime?
  codeOfComplianceDate DateTime?

  // Report Content (JSON for flexibility)
  scopeOfWorks    Json?
  methodology     Json?
  equipment       Json?
  findings        Json?
  analysis        Json?
  conclusions     Json?
  recommendations Json?

  // Executive Summary (structured for PDF)
  executiveSummary Json?   // { keyFindings: string[], majorDefects: string, overallCondition: string, criticalRecommendations: string[] }

  // Compliance Assessment (direct JSON fields)
  e2Compliance  Json?
  b2Compliance  Json?
  copCompliance Json?

  // Sign-off & Expert Declaration (High Court Rules Schedule 4)
  declarationSigned Boolean   @default(false)
  signedAt          DateTime?
  signatureUrl      String?

  // Expert Witness Declaration Data
  expertDeclaration Json?     // { expertiseConfirmed, codeOfConductAccepted, courtComplianceAccepted, falseEvidenceUnderstood, impartialityConfirmed, expertiseAreas: string[], qualificationsSummary: string }
  conflictDisclosure String?  @db.Text  // Free text disclosure of any conflicts of interest
  hasConflict        Boolean  @default(false)  // Whether inspector declared a conflict

  // PDF
  pdfUrl         String?
  pdfGeneratedAt DateTime?
  pdfVersion     Int       @default(1)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  submittedAt DateTime?
  approvedAt  DateTime?

  // Relations
  inspectorId String
  inspector   User    @relation(fields: [inspectorId], references: [id])
  reviewerId  String?

  photos               Photo[]
  videos               Video[]
  documents            Document[]
  defects              Defect[]
  roofElements         RoofElement[]
  auditLog             AuditLog[]
  complianceAssessment ComplianceAssessment?
  reviewComments       ReviewComment[]
  shares               ReportShare[]
  lbpComplaints        LBPComplaint[]

  // Revision tracking
  revisionRound Int @default(0) // 0 = initial submission, 1+ = resubmissions

  @@index([reportNumber])
  @@index([inspectorId])
  @@index([status])
  @@index([inspectionDate])
  @@index([createdAt])
}

enum ReportStatus {
  DRAFT
  IN_PROGRESS
  PENDING_REVIEW
  UNDER_REVIEW
  REVISION_REQUIRED
  APPROVED
  FINALISED
  ARCHIVED
}

enum PropertyType {
  RESIDENTIAL_1
  RESIDENTIAL_2
  RESIDENTIAL_3
  COMMERCIAL_LOW
  COMMERCIAL_HIGH
  INDUSTRIAL
}

enum InspectionType {
  FULL_INSPECTION
  VISUAL_ONLY
  NON_INVASIVE
  INVASIVE
  DISPUTE_RESOLUTION
  PRE_PURCHASE
  MAINTENANCE_REVIEW
  WARRANTY_CLAIM
}

// ============================================
// ROOF ELEMENTS
// ============================================

model RoofElement {
  id       String @id @default(cuid())
  reportId String
  report   Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  elementType ElementType
  location    String

  // Cladding Details
  claddingType    String?
  claddingProfile String?
  material        String?
  manufacturer    String?
  colour          String?

  // Technical Specs
  pitch    Float?
  area     Float?
  ageYears Int?

  // Condition Rating
  conditionRating ConditionRating?
  conditionNotes  String?          @db.Text

  // Compliance
  meetsCop Boolean?
  meetsE2  Boolean?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  defects Defect[]
  photos  Photo[]

  @@index([reportId])
}

enum ElementType {
  ROOF_CLADDING
  RIDGE
  VALLEY
  HIP
  BARGE
  FASCIA
  GUTTER
  DOWNPIPE
  FLASHING_WALL
  FLASHING_PENETRATION
  FLASHING_PARAPET
  SKYLIGHT
  VENT
  ANTENNA_MOUNT
  SOLAR_PANEL
  UNDERLAY
  INSULATION
  ROOF_STRUCTURE
  OTHER
}

enum ConditionRating {
  GOOD
  FAIR
  POOR
  CRITICAL
  NOT_INSPECTED
}

// ============================================
// DEFECTS
// ============================================

model Defect {
  id            String       @id @default(cuid())
  reportId      String
  report        Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  roofElementId String?
  roofElement   RoofElement? @relation(fields: [roofElementId], references: [id])

  defectNumber Int
  title        String
  description  String @db.Text
  location     String

  classification DefectClass
  severity       DefectSeverity

  // Three-part structure (ISO compliant)
  observation String  @db.Text
  analysis    String? @db.Text
  opinion     String? @db.Text

  // Compliance References
  codeReference String?
  copReference  String?

  // Causation
  probableCause       String? @db.Text
  contributingFactors String? @db.Text

  // Recommendations
  recommendation String?        @db.Text
  priorityLevel  PriorityLevel?
  estimatedCost  String?

  // Measurements
  measurements Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  photos Photo[]

  @@index([reportId])
  @@index([roofElementId])
}

enum DefectClass {
  MAJOR_DEFECT
  MINOR_DEFECT
  SAFETY_HAZARD
  MAINTENANCE_ITEM
  WORKMANSHIP_ISSUE
}

enum DefectSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum PriorityLevel {
  IMMEDIATE
  SHORT_TERM
  MEDIUM_TERM
  LONG_TERM
}

// ============================================
// MEDIA & EVIDENCE
// ============================================

model Photo {
  id            String       @id @default(cuid())
  reportId      String
  report        Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  defectId      String?
  defect        Defect?      @relation(fields: [defectId], references: [id])
  roofElementId String?
  roofElement   RoofElement? @relation(fields: [roofElementId], references: [id])

  // File Info
  filename         String
  originalFilename String
  mimeType         String
  fileSize         Int
  url              String
  thumbnailUrl     String?

  photoType PhotoType

  // EXIF Metadata (Critical for evidence)
  capturedAt   DateTime?
  gpsLat       Float?
  gpsLng       Float?
  gpsAltitude  Float?
  cameraMake   String?
  cameraModel  String?
  cameraSerial String?
  exposureTime String?
  fNumber      Float?
  iso          Int?
  focalLength  Float?

  // Evidence Integrity
  originalHash String
  hashVerified Boolean @default(false)
  isEdited     Boolean @default(false)
  editedFrom   String?

  // Annotations
  caption        String?
  annotations    Json?
  annotatedUrl   String?   // URL of the rendered annotated image
  scaleReference String?

  sortOrder Int @default(0)

  createdAt  DateTime @default(now())
  uploadedAt DateTime @default(now())

  @@index([reportId])
  @@index([defectId])
  @@index([roofElementId])
}

enum PhotoType {
  OVERVIEW
  CONTEXT
  DETAIL
  SCALE_REFERENCE
  INACCESSIBLE
  EQUIPMENT
  GENERAL
}

model Video {
  id       String @id @default(cuid())
  reportId String
  report   Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // File Info
  filename         String
  originalFilename String
  mimeType         String
  fileSize         Int
  duration         Int?
  url              String
  thumbnailUrl     String?

  // Metadata
  capturedAt DateTime?
  gpsLat     Float?
  gpsLng     Float?

  // Evidence Integrity
  originalHash String

  // Description
  title       String?
  description String? @db.Text

  createdAt DateTime @default(now())

  @@index([reportId])
}

model Document {
  id       String @id @default(cuid())
  reportId String
  report   Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  documentType DocumentType
  title        String
  filename     String
  mimeType     String
  fileSize     Int
  url          String

  createdAt DateTime @default(now())

  @@index([reportId])
}

enum DocumentType {
  BUILDING_CONSENT
  CODE_OF_COMPLIANCE
  MANUFACTURER_SPEC
  PREVIOUS_REPORT
  CORRESPONDENCE
  CALIBRATION_CERT
  OTHER
}

// ============================================
// AUDIT & COMPLIANCE
// ============================================

model AuditLog {
  id       String @id @default(cuid())
  reportId String
  report   Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  action    AuditAction
  userId    String
  details   Json?
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([reportId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

enum AuditAction {
  CREATED
  UPDATED
  PHOTO_ADDED
  PHOTO_DELETED
  VIDEO_ADDED
  DEFECT_ADDED
  DEFECT_UPDATED
  STATUS_CHANGED
  SUBMITTED
  REVIEWED
  APPROVED
  PDF_GENERATED
  DOWNLOADED
  SHARED
}

// ============================================
// REPORT SHARING
// ============================================

model ReportShare {
  id       String @id @default(cuid())
  reportId String
  report   Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // Secure token for the share link
  token String @unique @default(cuid())

  // Who created the share
  createdById String

  // Recipient info (for audit/notification)
  recipientEmail String?
  recipientName  String?

  // Access control
  accessLevel ShareAccessLevel @default(VIEW_ONLY)
  expiresAt   DateTime?
  password    String?          // Optional password protection (hashed)

  // Usage tracking
  viewCount     Int       @default(0)
  lastViewedAt  DateTime?
  downloadCount Int       @default(0)

  // Status
  isActive Boolean @default(true)
  revokedAt DateTime?
  revokedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reportId])
  @@index([token])
  @@index([createdById])
}

enum ShareAccessLevel {
  VIEW_ONLY       // Can view report online
  VIEW_DOWNLOAD   // Can view and download PDF
}

// ============================================
// ASSIGNMENTS & WORKFLOW
// ============================================

model Assignment {
  id          String @id @default(cuid())
  inspectorId String
  inspector   User   @relation(fields: [inspectorId], references: [id])

  // Client Request
  clientName      String
  clientEmail     String
  clientPhone     String?
  propertyAddress String

  // Assignment Details
  requestType InspectionType
  urgency     AssignmentUrgency
  notes       String?           @db.Text

  status AssignmentStatus @default(PENDING)

  scheduledDate DateTime?
  completedDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([inspectorId])
  @@index([status])
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AssignmentUrgency {
  STANDARD
  PRIORITY
  URGENT
  EMERGENCY
}

// ============================================
// TEMPLATES & CONFIGURATION
// ============================================

model ReportTemplate {
  id             String         @id @default(cuid())
  name           String         @unique
  description    String?
  inspectionType InspectionType
  sections       Json
  checklists     Json?
  isDefault      Boolean        @default(false)
  isActive       Boolean        @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Checklist {
  id       String  @id @default(cuid())
  name     String
  category String
  standard String?
  items    Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([standard])
}

model ComplianceAssessment {
  id       String @id @default(cuid())
  reportId String @unique
  report   Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  checklistResults     Json
  nonComplianceSummary String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reportId])
}

// ============================================
// REVIEW COMMENTS & FEEDBACK
// ============================================

model ReviewComment {
  id       String @id @default(cuid())
  reportId String
  report   Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  reviewerId String
  reviewer   User   @relation("ReviewComments", fields: [reviewerId], references: [id])

  // Optional targeting - can comment on specific items
  defectId      String?
  roofElementId String?
  photoId       String?
  section       String? // e.g., "property_details", "compliance", "conclusions"

  // Comment content
  comment  String         @db.Text
  severity CommentSeverity @default(NOTE)

  // Resolution tracking
  resolved   Boolean   @default(false)
  resolvedAt DateTime?
  resolvedBy String?

  // Revision round this comment belongs to
  revisionRound Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reportId])
  @@index([reviewerId])
  @@index([resolved])
}

enum CommentSeverity {
  CRITICAL    // Must be fixed before approval
  ISSUE       // Should be addressed
  NOTE        // Informational feedback
  SUGGESTION  // Optional improvement
}

// ============================================
// LBP COMPLAINT SYSTEM
// ============================================

model LBPComplaint {
  id                    String             @id @default(cuid())
  complaintNumber       String             @unique // Format: RANZ-LBP-YYYY-NNNNN

  // Links to source report
  reportId              String
  report                Report             @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // Complaint details
  status                LBPComplaintStatus @default(DRAFT)
  groundsForDiscipline  String[] // Array of grounds (Building Act 317 sections)
  conductDescription    String             @db.Text
  evidenceSummary       String             @db.Text
  stepsToResolve        String?            @db.Text // Steps taken before complaint

  // Subject LBP details (the person being complained about)
  subjectLbpNumber      String
  subjectLbpName        String
  subjectLbpEmail       String?
  subjectLbpPhone       String?
  subjectLbpCompany     String?
  subjectLbpAddress     String?
  subjectLbpLicenseTypes String[] // Roofing, Design, Site, etc.
  subjectSightedLicense Boolean            @default(false)
  subjectWorkType       String? // "carried_out", "supervised", "both"

  // Work details
  workAddress           String
  workSuburb            String?
  workCity              String?
  workStartDate         DateTime?
  workEndDate           DateTime?
  workDescription       String             @db.Text
  buildingConsentNumber String?
  buildingConsentDate   DateTime?

  // Witnesses (JSON array of witness objects)
  witnesses             Json? // [{name, phone, email, role, details}]

  // Evidence attachments (references to existing photos/defects)
  attachedPhotoIds      String[]
  attachedDefectIds     String[]
  inspectorReportUrl    String?
  additionalAttachments String[] // URLs to other evidence

  // Complainant details (RANZ)
  complainantName       String             @default("Roofing Association of New Zealand")
  complainantAddress    String?
  complainantPhone      String?
  complainantEmail      String?
  complainantRelation   String             @default("Third-party inspector")

  // Preparation & Review
  preparedBy            String // Admin user ID
  preparedByName        String
  preparedByEmail       String
  preparedAt            DateTime           @default(now())

  reviewedBy            String? // Senior admin user ID
  reviewedByName        String?
  reviewedAt            DateTime?
  reviewNotes           String?            @db.Text

  // Digital signature
  signedBy              String? // Admin user ID
  signedByName          String?
  signatureData         String? // Base64 signature image
  signedAt              DateTime?
  declarationAccepted   Boolean            @default(false)

  // Submission tracking
  submittedBy           String? // Admin who clicked submit
  submittedByName       String?
  submittedAt           DateTime?
  submissionMethod      String? // "EMAIL", "POSTAL"
  submissionEmail       String? // Email sent to
  submissionConfirmation String? // Email send confirmation ID

  // Generated documents
  complaintPdfUrl       String?
  complaintPdfHash      String? // SHA-256 for integrity
  evidencePackageUrl    String?
  evidencePackageHash   String?

  // BPB response tracking
  bpbReference          String? // BPB case number if provided
  bpbAcknowledgedAt     DateTime?
  bpbDecision           String? // "PROCEED_TO_HEARING", "DISMISSED", etc.
  bpbDecisionDate       DateTime?
  bpbOutcome            String?            @db.Text
  bpbNotes              String?            @db.Text

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  @@index([reportId])
  @@index([status])
  @@index([subjectLbpNumber])
  @@index([complaintNumber])
}

enum LBPComplaintStatus {
  DRAFT // Being prepared by admin
  PENDING_REVIEW // Awaiting senior admin review
  READY_TO_SUBMIT // Approved, ready to send
  SUBMITTED // Sent to BPB
  ACKNOWLEDGED // BPB confirmed receipt
  UNDER_INVESTIGATION // BPB investigating
  HEARING_SCHEDULED // Going to hearing
  DECIDED // BPB made decision
  CLOSED // Case closed
  WITHDRAWN // Complaint withdrawn
}
