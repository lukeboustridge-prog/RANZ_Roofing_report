generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id      String     @id @default(cuid())
  clerkId String     @unique
  email   String     @unique
  name    String
  phone   String?
  role    UserRole   @default(INSPECTOR)
  status  UserStatus @default(ACTIVE)

  // Business details
  company String?
  address String? @db.Text

  // Inspector credentials
  qualifications  String?  @db.Text
  lbpNumber       String?
  yearsExperience Int?
  specialisations String[]
  cvUrl           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reports     Report[]
  assignments Assignment[]
}

enum UserRole {
  INSPECTOR
  REVIEWER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  PENDING_APPROVAL
}

// ============================================
// INSPECTION REPORTS
// ============================================

model Report {
  id           String       @id @default(cuid())
  reportNumber String       @unique // RANZ-2025-001234
  status       ReportStatus @default(DRAFT)

  // Property Details
  propertyAddress  String
  propertyCity     String
  propertyRegion   String
  propertyPostcode String
  propertyType     PropertyType
  buildingAge      Int?
  gpsLat           Float?
  gpsLng           Float?

  // Inspection Details
  inspectionDate    DateTime
  inspectionType    InspectionType
  weatherConditions String?
  temperature       Float?
  accessMethod      String?
  limitations       String?        @db.Text

  // Client Information
  clientName    String
  clientEmail   String?
  clientPhone   String?
  clientCompany String?
  engagingParty String?

  // Building Consent
  consentNumber        String?
  consentDate          DateTime?
  codeOfComplianceDate DateTime?

  // Report Content (JSON for flexibility)
  scopeOfWorks    Json?
  methodology     Json?
  equipment       Json?
  findings        Json?
  analysis        Json?
  conclusions     Json?
  recommendations Json?

  // Compliance Assessment (direct JSON fields)
  e2Compliance  Json?
  b2Compliance  Json?
  copCompliance Json?

  // Sign-off
  declarationSigned Boolean   @default(false)
  signedAt          DateTime?
  signatureUrl      String?

  // PDF
  pdfUrl         String?
  pdfGeneratedAt DateTime?
  pdfVersion     Int       @default(1)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  submittedAt DateTime?
  approvedAt  DateTime?

  // Relations
  inspectorId String
  inspector   User    @relation(fields: [inspectorId], references: [id])
  reviewerId  String?

  photos               Photo[]
  videos               Video[]
  documents            Document[]
  defects              Defect[]
  roofElements         RoofElement[]
  auditLog             AuditLog[]
  complianceAssessment ComplianceAssessment?

  @@index([reportNumber])
  @@index([inspectorId])
  @@index([status])
  @@index([inspectionDate])
  @@index([createdAt])
}

enum ReportStatus {
  DRAFT
  IN_PROGRESS
  PENDING_REVIEW
  UNDER_REVIEW
  REVISION_REQUIRED
  APPROVED
  FINALISED
  ARCHIVED
}

enum PropertyType {
  RESIDENTIAL_1
  RESIDENTIAL_2
  RESIDENTIAL_3
  COMMERCIAL_LOW
  COMMERCIAL_HIGH
  INDUSTRIAL
}

enum InspectionType {
  FULL_INSPECTION
  VISUAL_ONLY
  NON_INVASIVE
  INVASIVE
  DISPUTE_RESOLUTION
  PRE_PURCHASE
  MAINTENANCE_REVIEW
  WARRANTY_CLAIM
}

// ============================================
// ROOF ELEMENTS
// ============================================

model RoofElement {
  id       String @id @default(cuid())
  reportId String
  report   Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  elementType ElementType
  location    String

  // Cladding Details
  claddingType    String?
  claddingProfile String?
  material        String?
  manufacturer    String?
  colour          String?

  // Technical Specs
  pitch    Float?
  area     Float?
  ageYears Int?

  // Condition Rating
  conditionRating ConditionRating?
  conditionNotes  String?          @db.Text

  // Compliance
  meetsCop Boolean?
  meetsE2  Boolean?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  defects Defect[]
  photos  Photo[]

  @@index([reportId])
}

enum ElementType {
  ROOF_CLADDING
  RIDGE
  VALLEY
  HIP
  BARGE
  FASCIA
  GUTTER
  DOWNPIPE
  FLASHING_WALL
  FLASHING_PENETRATION
  FLASHING_PARAPET
  SKYLIGHT
  VENT
  ANTENNA_MOUNT
  SOLAR_PANEL
  UNDERLAY
  INSULATION
  ROOF_STRUCTURE
  OTHER
}

enum ConditionRating {
  GOOD
  FAIR
  POOR
  CRITICAL
  NOT_INSPECTED
}

// ============================================
// DEFECTS
// ============================================

model Defect {
  id            String       @id @default(cuid())
  reportId      String
  report        Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  roofElementId String?
  roofElement   RoofElement? @relation(fields: [roofElementId], references: [id])

  defectNumber Int
  title        String
  description  String @db.Text
  location     String

  classification DefectClass
  severity       DefectSeverity

  // Three-part structure (ISO compliant)
  observation String  @db.Text
  analysis    String? @db.Text
  opinion     String? @db.Text

  // Compliance References
  codeReference String?
  copReference  String?

  // Causation
  probableCause       String? @db.Text
  contributingFactors String? @db.Text

  // Recommendations
  recommendation String?        @db.Text
  priorityLevel  PriorityLevel?
  estimatedCost  String?

  // Measurements
  measurements Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  photos Photo[]

  @@index([reportId])
  @@index([roofElementId])
}

enum DefectClass {
  MAJOR_DEFECT
  MINOR_DEFECT
  SAFETY_HAZARD
  MAINTENANCE_ITEM
  WORKMANSHIP_ISSUE
}

enum DefectSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum PriorityLevel {
  IMMEDIATE
  SHORT_TERM
  MEDIUM_TERM
  LONG_TERM
}

// ============================================
// MEDIA & EVIDENCE
// ============================================

model Photo {
  id            String       @id @default(cuid())
  reportId      String
  report        Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)
  defectId      String?
  defect        Defect?      @relation(fields: [defectId], references: [id])
  roofElementId String?
  roofElement   RoofElement? @relation(fields: [roofElementId], references: [id])

  // File Info
  filename         String
  originalFilename String
  mimeType         String
  fileSize         Int
  url              String
  thumbnailUrl     String?

  photoType PhotoType

  // EXIF Metadata (Critical for evidence)
  capturedAt   DateTime?
  gpsLat       Float?
  gpsLng       Float?
  gpsAltitude  Float?
  cameraMake   String?
  cameraModel  String?
  cameraSerial String?
  exposureTime String?
  fNumber      Float?
  iso          Int?
  focalLength  Float?

  // Evidence Integrity
  originalHash String
  hashVerified Boolean @default(false)
  isEdited     Boolean @default(false)
  editedFrom   String?

  // Annotations
  caption        String?
  annotations    Json?
  scaleReference String?

  sortOrder Int @default(0)

  createdAt  DateTime @default(now())
  uploadedAt DateTime @default(now())

  @@index([reportId])
  @@index([defectId])
  @@index([roofElementId])
}

enum PhotoType {
  OVERVIEW
  CONTEXT
  DETAIL
  SCALE_REFERENCE
  INACCESSIBLE
  EQUIPMENT
  GENERAL
}

model Video {
  id       String @id @default(cuid())
  reportId String
  report   Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // File Info
  filename         String
  originalFilename String
  mimeType         String
  fileSize         Int
  duration         Int?
  url              String
  thumbnailUrl     String?

  // Metadata
  capturedAt DateTime?
  gpsLat     Float?
  gpsLng     Float?

  // Evidence Integrity
  originalHash String

  // Description
  title       String?
  description String? @db.Text

  createdAt DateTime @default(now())

  @@index([reportId])
}

model Document {
  id       String @id @default(cuid())
  reportId String
  report   Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  documentType DocumentType
  title        String
  filename     String
  mimeType     String
  fileSize     Int
  url          String

  createdAt DateTime @default(now())

  @@index([reportId])
}

enum DocumentType {
  BUILDING_CONSENT
  CODE_OF_COMPLIANCE
  MANUFACTURER_SPEC
  PREVIOUS_REPORT
  CORRESPONDENCE
  CALIBRATION_CERT
  OTHER
}

// ============================================
// AUDIT & COMPLIANCE
// ============================================

model AuditLog {
  id       String @id @default(cuid())
  reportId String
  report   Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  action    AuditAction
  userId    String
  details   Json?
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([reportId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

enum AuditAction {
  CREATED
  UPDATED
  PHOTO_ADDED
  PHOTO_DELETED
  VIDEO_ADDED
  DEFECT_ADDED
  DEFECT_UPDATED
  STATUS_CHANGED
  SUBMITTED
  REVIEWED
  APPROVED
  PDF_GENERATED
  DOWNLOADED
  SHARED
}

// ============================================
// ASSIGNMENTS & WORKFLOW
// ============================================

model Assignment {
  id          String @id @default(cuid())
  inspectorId String
  inspector   User   @relation(fields: [inspectorId], references: [id])

  // Client Request
  clientName      String
  clientEmail     String
  clientPhone     String?
  propertyAddress String

  // Assignment Details
  requestType InspectionType
  urgency     AssignmentUrgency
  notes       String?           @db.Text

  status AssignmentStatus @default(PENDING)

  scheduledDate DateTime?
  completedDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([inspectorId])
  @@index([status])
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AssignmentUrgency {
  STANDARD
  PRIORITY
  URGENT
  EMERGENCY
}

// ============================================
// TEMPLATES & CONFIGURATION
// ============================================

model ReportTemplate {
  id             String         @id @default(cuid())
  name           String         @unique
  description    String?
  inspectionType InspectionType
  sections       Json
  checklists     Json?
  isDefault      Boolean        @default(false)
  isActive       Boolean        @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Checklist {
  id       String  @id @default(cuid())
  name     String
  category String
  standard String?
  items    Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([standard])
}

model ComplianceAssessment {
  id       String @id @default(cuid())
  reportId String @unique
  report   Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  checklistResults     Json
  nonComplianceSummary String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reportId])
}
